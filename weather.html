<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thời tiết Chân Mây - Lăng Cô</title>
  <link rel="stylesheet" href="weather.css">
</head>
<body>
  <div class="weather-widget" id="weatherWidget">
    <div class="animation-layer" id="animationLayer"></div>
    <div class="widget-content">
      <div class="loading">
        <div class="spinner"></div>
        <div>Đang tải dữ liệu thời tiết...</div>
      </div>
    </div>
  </div>

  <script>
    const apiKey = "341ef82998b57b3239a9ab9c1f418d91"; // Dán API key của bạn vào đây
    const lat = 16.2460;
    const lon = 108.014;

    const weatherIcons = {
      '01d': '☀️', '01n': '🌙',
      '02d': '⛅', '02n': '☁️',
      '03d': '☁️', '03n': '☁️',
      '04d': '☁️', '04n': '☁️',
      '09d': '🌧️', '09n': '🌧️',
      '10d': '🌦️', '10n': '🌧️',
      '11d': '⛈️', '11n': '⛈️',
      '13d': '❄️', '13n': '❄️',
      '50d': '🌫️', '50n': '🌫️'
    };

    async function getWeather() {
      try {
        const response = await fetch(
          `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric&lang=vi`
        );
        const data = await response.json();

        if (data.cod !== 200) {
          showError("Không thể lấy dữ liệu thời tiết. Vui lòng kiểm tra API key.");
          return;
        }

        displayWeather(data);
      } catch (error) {
        showError("Lỗi kết nối. Vui lòng thử lại sau.");
        console.error(error);
      }
    }

    function createRainAnimation() {
      const layer = document.getElementById('animationLayer');
      layer.innerHTML = '';
      for (let i = 0; i < 50; i++) {
        const drop = document.createElement('div');
        drop.className = 'rain-drop';
        drop.style.left = Math.random() * 100 + '%';
        drop.style.animationDuration = (Math.random() * 0.5 + 0.5) + 's';
        drop.style.animationDelay = Math.random() * 2 + 's';
        layer.appendChild(drop);
      }
    }

    function createSnowAnimation() {
      const layer = document.getElementById('animationLayer');
      layer.innerHTML = '';
      for (let i = 0; i < 30; i++) {
        const flake = document.createElement('div');
        flake.className = 'snow-flake';
        flake.style.left = Math.random() * 100 + '%';
        flake.style.animationDuration = (Math.random() * 3 + 2) + 's';
        flake.style.animationDelay = Math.random() * 3 + 's';
        layer.appendChild(flake);
      }
    }

    function createCloudAnimation() {
      const layer = document.getElementById('animationLayer');
      layer.innerHTML = '';
      for (let i = 0; i < 3; i++) {
        const cloud = document.createElement('div');
        cloud.className = 'cloud';
        cloud.style.width = (Math.random() * 60 + 40) + 'px';
        cloud.style.height = (Math.random() * 30 + 20) + 'px';
        cloud.style.top = (Math.random() * 60 + 10) + '%';
        cloud.style.left = '-100px';
        cloud.style.animationDuration = (Math.random() * 15 + 10) + 's';
        cloud.style.animationDelay = i * 3 + 's';
        layer.appendChild(cloud);
      }
    }

    function createThunderstormAnimation() {
      const layer = document.getElementById('animationLayer');
      layer.innerHTML = '';
      const lightning = document.createElement('div');
      lightning.className = 'lightning';
      layer.appendChild(lightning);
      createRainAnimation();
    }

    function createSunAnimation() {
      const layer = document.getElementById('animationLayer');
      layer.innerHTML = '';
      const sunRays = document.createElement('div');
      sunRays.className = 'sun-rays';
      for (let i = 0; i < 12; i++) {
        const ray = document.createElement('div');
        ray.className = 'sun-ray';
        ray.style.transform = `rotate(${i * 30}deg)`;
        sunRays.appendChild(ray);
      }
      layer.appendChild(sunRays);
    }

    function createWeatherAnimation(weatherMain) {
      const animations = {
        'clear': createSunAnimation,
        'clouds': createCloudAnimation,
        'rain': createRainAnimation,
        'drizzle': createRainAnimation,
        'thunderstorm': createThunderstormAnimation,
        'snow': createSnowAnimation,
        'mist': createCloudAnimation
      };
      
      const animationFunc = animations[weatherMain.toLowerCase()];
      if (animationFunc) {
        animationFunc();
      }
    }

    function displayWeather(data) {
      const iconCode = data.weather[0].icon;
      const icon = weatherIcons[iconCode] || '🌤️';
      const now = new Date().toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
      
      // Thay đổi màu nền widget theo thời tiết
      const weatherMain = data.weather[0].main.toLowerCase();
      const widget = document.getElementById('weatherWidget');
      widget.className = 'weather-widget ' + weatherMain;
      
      // Tạo animation theo thời tiết
      createWeatherAnimation(weatherMain);

      const content = widget.querySelector('.widget-content') || widget;
      content.innerHTML = `
        <div class="location">
          <span class="location-icon">📍</span>
          <span>Chân Mây - Lăng Cô</span>
        </div>
        
        <div class="weather-main">
          <div class="weather-icon">${icon}</div>
          <div class="temperature">${Math.round(data.main.temp)}°C</div>
          <div class="description">${data.weather[0].description}</div>
        </div>
        
        <div class="weather-details">
          <div class="detail-item">
            <span class="detail-icon">💧</span>
            <span class="detail-label">Độ ẩm</span>
            <span class="detail-value">${data.main.humidity}%</span>
          </div>
          
          <div class="detail-item">
            <span class="detail-icon">🌬️</span>
            <span class="detail-label">Gió</span>
            <span class="detail-value">${data.wind.speed} m/s</span>
          </div>
          
          <div class="detail-item">
            <span class="detail-icon">🌡️</span>
            <span class="detail-label">Cảm giác</span>
            <span class="detail-value">${Math.round(data.main.feels_like)}°C</span>
          </div>
          
          <div class="detail-item">
            <span class="detail-icon">👁️</span>
            <span class="detail-label">Tầm nhìn</span>
            <span class="detail-value">${(data.visibility / 1000).toFixed(1)} km</span>
          </div>
        </div>
        
        <div class="last-update">Cập nhật lúc ${now}</div>
      `;
    }

    function showError(message) {
      document.getElementById('weatherWidget').innerHTML = `
        <div class="error">
          ⚠️<br><br>${message}
        </div>
      `;
    }

    getWeather();
    setInterval(getWeather, 600000); // Cập nhật mỗi 10 phút
  </script>
</body>
</html>