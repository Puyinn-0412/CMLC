<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>B·∫£n ƒë·ªì Ch√¢n M√¢y - LƒÉng C√¥</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Turf.js ƒë·ªÉ t√≠nh di·ªán t√≠ch polygon -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <link rel="stylesheet" href="stylemap.css" />

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

</head>
<body>
  <div id="map"></div>
  
  <!-- Loading indicator -->
  <div class="loading" id="loading">
    <div class="loading-spinner"></div>
    <span>ƒêang t·∫£i b·∫£n ƒë·ªì...</span>
  </div>
  
  <!-- Info Panel -->
  <div class="info-panel" id="info-panel">
    <div class="info-header">
      <img id="info-image" src="" alt="" class="info-image">
      <button class="info-close" id="info-close">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="info-content">
      <h2 class="info-title" id="info-title"></h2>
      <p class="info-description" id="info-description"></p>
      
      <!-- Tags trong info panel -->
      <div class="info-tags" id="info-tags">
        <!-- Tags s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
      </div>
      
      <div class="info-details">
        <div class="info-detail">
          <i class="fas fa-map-marker-alt"></i>
          <strong>ƒê·ªãa ch·ªâ:</strong> <span id="info-address"></span>
        </div>
        <div class="info-detail">
          <i class="fas fa-phone"></i>
          <strong>ƒêi·ªán tho·∫°i:</strong> <span id="info-phone"></span>
        </div>
        <div class="info-detail">
          <i class="fas fa-clock"></i>
          <strong>Gi·ªù m·ªü c·ª≠a:</strong> <span id="info-hours"></span>
        </div>
        <div class="info-detail">
          <i class="fas fa-tag"></i>
          <strong>Gi√° v√©:</strong> <span id="info-price"></span>
        </div>
      </div>
      
      <!-- Tips & L∆∞u √Ω Section -->
      <div class="tips-section">
        <div class="tips-header" id="tips-header">
          <div class="tips-title">
            <i class="fas fa-lightbulb"></i>
            <span>Tips & L∆∞u √Ω</span>
          </div>
          <button class="tips-toggle" id="tips-toggle">
            <i class="fas fa-chevron-down"></i>
          </button>
        </div>
        <div class="tips-content" id="tips-content">
          <ul class="tips-list" id="tips-list">
            <!-- Tips s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
          </ul>
        </div>
      </div>
      
      <div class="info-actions">
        <button class="info-btn secondary" id="info-direction">
          <i class="fas fa-route"></i> Ch·ªâ ƒë∆∞·ªùng
        </button>
        <button class="info-btn primary" id="info-website">
          <i class="fas fa-external-link-alt"></i> Website
        </button>
      </div>
    </div>
  </div>
  
  <!-- Map Controls -->
  <div class="map-controls">
    <button class="map-control" id="locate-me" title="V·ªã tr√≠ c·ªßa t√¥i">
      <i class="fas fa-location-arrow"></i>
    </button>
    <button class="map-control" id="toggle-boundary" title="Ranh gi·ªõi">
      <i class="fas fa-draw-polygon"></i>
    </button>
    <button class="map-control" id="toggle-satellite" title="Ch·∫ø ƒë·ªô v·ªá tinh">
      <i class="fas fa-satellite"></i>
    </button>
    <button class="map-control" id="fullscreen" title="To√†n m√†n h√¨nh">
      <i class="fas fa-expand"></i>
    </button>
  </div>
  
  <!-- Legend -->
  <div class="legend" id="legend">
    <h4>
      <span>Ch√∫ th√≠ch</span>
      <button class="legend-toggle" id="legend-toggle" title="·∫®n/hi·ªán ch√∫ th√≠ch">
        <i class="fas fa-eye-slash"></i>
      </button>
    </h4>
    <div class="legend-item">
      <div class="legend-color boundary-color"></div>
      <span>Ranh gi·ªõi khu v·ª±c</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #e74c3c; border-color: #c0392b;"></div>
      <span>Di t√≠ch l·ªãch s·ª≠</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #3498db; border-color: #2980b9;"></div>
      <span>B√£i bi·ªÉn & ƒê·∫ßm n∆∞·ªõc</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #27ae60; border-color: #219a52;"></div>
      <span>Su·ªëi & Th√°c n∆∞·ªõc</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #f39c12; border-color: #e67e22;"></div>
      <span>Khu ngh·ªâ d∆∞·ª°ng</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #9b59b6; border-color: #8e44ad;"></div>
      <span>Ch√πa & Nh√† th·ªù</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #e67e22; border-color: #d35400;"></div>
      <span>Khu mua s·∫Øm</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #1abc9c; border-color: #16a085;"></div>
      <span>Nh√† h√†ng & ·∫®m th·ª±c</span>
    </div>
  </div>

  <!-- N√∫t hi·ªán ch√∫ th√≠ch khi ƒë√£ ·∫©n -->
  <button class="legend-show" id="legend-show" title="Hi·ªán ch√∫ th√≠ch">
    <i class="fas fa-map"></i>
  </button>

  <script>
    // ========== C·∫§U TR√öC D·ªÆ LI·ªÜU V√Ä C·∫§U H√åNH ==========
    
    // C·∫•u h√¨nh ·ª©ng d·ª•ng
    const APP_CONFIG = {
      mapCenter: [16.27, 108.06],
      defaultZoom: 12,
      osmRelationId: 19325212,
      boundaryColor: "#3498db",
      boundaryOpacity: 0.15,
      boundaryWeight: 3
    };

    // D·ªØ li·ªáu c√°c ƒëi·ªÉm ƒë√°nh d·∫•u v·ªõi th√¥ng tin l·ªçc n√¢ng cao
    const MARKERS_DATA = [
      {
        id: 1,
        coords: [16.188057091935168, 108.13126200900261],
        title: "H·∫£i V√¢n Quan",
        description: "H·∫£i V√¢n Quan l√† di t√≠ch l·ªãch s·ª≠ qu√¢n s·ª± th·ªùi Nguy·ªÖn, x√¢y d·ª±ng nƒÉm 1826 tr√™n ƒë·ªânh ƒë√®o H·∫£i V√¢n, ranh gi·ªõi gi·ªØa Hu·∫ø v√† ƒê√† N·∫µng, n·ªïi ti·∫øng v·ªõi ki·∫øn tr√∫c ƒë·ªôc ƒë√°o v√† c·∫£nh quan h√πng vƒ©.",
        image: "https://live.staticflickr.com/573/31685434851_63ec23ccf6_b.jpg",
        category: "ditich",
        color: "#e74c3c",
        link: "https://www.google.com/maps/place/H%E1%BA%A3i+V%C3%A2n+Quan/@16.1877377,108.1287193,836m/data=!3m2!1e3!4b1!4m6!3m5!1s0x3142219e02bc568b:0xb04a3eba486386b5!8m2!3d16.1877377!4d108.1312942!16s%2Fg%2F11p5lgqrq9?hl=vi&entry=ttu&g_ep=EgoyMDI5MTAwOC4wIKXMDSoASAFQAw%3D%3D",
        address: " ƒê√®o H·∫£i V√¢n, gi√°p ranh Th√†nh ph·ªë Hu·∫ø v√† ƒê√† N·∫µng",
        phone: "",
        hours: " 07:00‚Äì17:30",
        price: " Mi·ªÖn ph√≠",
        // Th√¥ng tin l·ªçc n√¢ng cao
        filters: {
          type: "ditich",
          suitability: ["family", "couple", "solo"],
          budget: 0,
          age: ["child", "teen", "adult", "senior"],
        },
        // Th√™m tips v√† l∆∞u √Ω
        tips: [
          {
            type: "tip",
            title: "Th·ªùi ƒëi·ªÉm t·ªët nh·∫•t",
            text: "N√™n ƒë·∫øn v√†o s√°ng s·ªõm ho·∫∑c chi·ªÅu mu·ªôn ƒë·ªÉ tr√°nh s∆∞∆°ng m√π v√† c√≥ t·∫ßm nh√¨n ƒë·∫πp nh·∫•t."
          },
          {
            type: "warning",
            title: "L∆∞u √Ω an to√†n",
            text: "Di chuy·ªÉn qua ƒë√®o H·∫£i V√¢n: Kh√¥ng chen l·∫•n, ƒëi h√†ng 2-3 ng∆∞·ªùi, gi·ªØ t·ªëc ƒë·ªô ch·∫≠m ·ªü c√°c kh√∫c cua ƒë·ªÉ ƒë·∫£m b·∫£o an to√†n."
          },
          {
            type: "info",
            title: "Ch·ª•p ·∫£nh",
            text: "ƒê√¢y l√† ƒëi·ªÉm ch·ª•p ·∫£nh tuy·ªát v·ªùi v·ªõi view to√†n c·∫£nh ƒë√®o H·∫£i V√¢n v√† bi·ªÉn."
          }
        ]
      },
      {
        id: 2,
        coords: [16.221596913531673, 108.0615628955108],
        title: "ƒê·∫ßm L·∫≠p An",
        description: "ƒê·∫ßm L·∫≠p An l√† ƒë·∫ßm n∆∞·ªõc l·ª£ l·ªõn nh·∫•t Hu·∫ø, n·∫±m b√™n v·ªãnh LƒÉng C√¥, n·ªïi ti·∫øng v·ªõi v·∫ª ƒë·∫πp y√™n b√¨nh, huy·ªÅn ·∫£o nh∆∞ Tuy·ªát t√¨nh c·ªëc gi·ªØa n√∫i non h√πng vƒ©.",
        image: "https://upload.wikimedia.org/wikipedia/commons/c/c9/Laguna_Lap_An%2C_Provincia_de_Thua_Thien-Hue%2C_Vietnam.jpg",
        category: "damnuoc",
        color: "#3498db",
        link: "https://example.com/dam-lap-an",
        address: "X√£ Ch√¢n M√¢y LƒÉng C√¥, Th√†nh ph·ªë Hu·∫ø",
        phone: "",
        hours: "M·ªü c·∫£ ng√†y",
        price: "Mi·ªÖn ph√≠",
        filters: {
          type: "damnuoc",
          suitability: ["family", "couple", "solo"],
          budget: 0,
          age: ["child", "teen", "adult", "senior"],
        },
        tips: [
          {
            type: "tip",
            title: "Th·ªùi ƒëi·ªÉm ƒë·∫πp nh·∫•t",
            text: "ƒêi v√†o m√πa kh√¥ (th√°ng 3-8) ƒë·ªÉ th·ªùi ti·∫øt ƒë·∫πp, d·ªÖ di chuy·ªÉn; n√™n ƒë·∫øn s√°ng s·ªõm ho·∫∑c chi·ªÅu mu·ªôn ƒë·ªÉ ng·∫Øm b√¨nh minh/ho√†ng h√¥n tuy·ªát ƒë·∫πp v√† ch·ª•p ·∫£nh check-in tr√™n con ƒë∆∞·ªùng gi·ªØa ƒë·∫ßm."
          },
          {
            type: "tip",
            title: "·∫®m th·ª±c",
            text: "Th·ª≠ c√°c m√≥n h·∫£i s·∫£n t∆∞∆°i nh∆∞ h√†u n∆∞·ªõng, t√¥m h√πm t·∫°i c√°c nh√† h√†ng ven ƒë·∫ßm ƒë·ªÉ tr·∫£i nghi·ªám ·∫©m th·ª±c ƒë·ªãa ph∆∞∆°ng."
          },
          {
            type: "info",
            title: "Tr·∫£i nghi·ªám",
            text: "C√≥ th·ªÉ tham quan c√°c b√® nu√¥i h√†u v√† th∆∞·ªüng th·ª©c h·∫£i s·∫£n t∆∞∆°i s·ªëng t·∫°i ƒë·ªãa ph∆∞∆°ng."
          },
          {
            type: "warning",
            title: "L∆∞u √Ω",
            text: "Mang theo kem ch·ªëng n·∫Øng, m≈© n√≥n, n∆∞·ªõc u·ªëng v√¨ n·∫Øng n√≥ng; tr√°nh ƒëi m√πa m∆∞a (th√°ng 9-12) do ƒë∆∞·ªùng tr∆°n tr∆∞·ª£t v√† l≈© l·ª•t."
          }
        ]
      },
      // ... (gi·ªØ nguy√™n t·∫•t c·∫£ c√°c marker kh√°c)
      // L∆∞u √Ω: T√¥i ƒë√£ c·∫Øt b·ªõt ph·∫ßn data ƒë·ªÉ l√†m m√£ ng·∫Øn g·ªçn h∆°n
      // Trong th·ª±c t·∫ø b·∫°n n√™n gi·ªØ to√†n b·ªô d·ªØ li·ªáu MARKERS_DATA
    ];

    // ========== KH·ªûI T·∫†O ·ª®NG D·ª§NG ==========
    // T·∫Øt zoom control m·∫∑c ƒë·ªãnh
    const map = L.map("map", {
      zoomControl: false
    }).setView(APP_CONFIG.mapCenter, APP_CONFIG.defaultZoom);

    // Th√™m zoom control ·ªü v·ªã tr√≠ m·ªõi
    L.control.zoom({
      position: 'topright'
    }).addTo(map);

    // Th√™m l·ªõp b·∫£n ƒë·ªì
    const osmLayer = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 18,
      attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
    }).addTo(map);

    // Th√™m l·ªõp b·∫£n ƒë·ªì v·ªá tinh
    const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
      maxZoom: 18
    });

    // Bi·∫øn to√†n c·ª•c
    let boundaryLayer;
    let boundaryVisible = true;
    let isSatellite = false;
    let markerObjects = [];
    let currentMarkerIndex = -1;
    let legendVisible = true;

    // ========== H√ÄM TI·ªÜN √çCH ==========
    
    // H√†m t·∫°o icon marker
    function createSimpleIcon(color) {
      return L.divIcon({
        className: 'simple-marker',
        html: `<div style="background-color: ${color}; width: 24px; height: 24px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.5);"></div>`,
        iconSize: [24, 24],
        iconAnchor: [12, 24]
      });
    }

    // H√†m ·∫©n loading indicator
    function hideLoading() {
      const loading = document.getElementById('loading');
      loading.style.display = 'none';
    }

    // H√†m x·ª≠ l√Ω l·ªói
    function handleError(error, context) {
      console.error(`L·ªói trong ${context}:`, error);
    }

    // ========== QU·∫¢N L√ù RANH GI·ªöI ==========
    
    // H√†m t·∫°o ranh gi·ªõi ∆∞·ªõc l∆∞·ª£ng
    function createEstimatedBoundary() {
      const coords = [
        [16.26, 108.00],
        [16.25, 108.10],
        [16.20, 108.12],
        [16.18, 108.06],
        [16.21, 108.00],
      ];
      
      boundaryLayer = L.polygon(coords, {
        color: APP_CONFIG.boundaryColor,
        weight: APP_CONFIG.boundaryWeight,
        fillColor: APP_CONFIG.boundaryColor,
        fillOpacity: APP_CONFIG.boundaryOpacity,
      }).addTo(map);

      boundaryLayer.bindPopup(`
        <div class="popup-title">Ch√¢n M√¢y - LƒÉng C√¥</div>
        <div class="popup-description">V√πng du l·ªãch ven bi·ªÉn</div>
      `);
      
      hideLoading();
    }

    // H√†m t·∫°o ranh gi·ªõi t·ª´ d·ªØ li·ªáu OSM
    function createBoundaryFromOSMData(data) {
      try {
        const relation = data.elements.find((el) => el.type === "relation");
        if (!relation) {
          throw new Error("Kh√¥ng t√¨m th·∫•y relation trong d·ªØ li·ªáu OSM");
        }

        const nodes = new Map();
        data.elements
          .filter((el) => el.type === "node")
          .forEach((node) => nodes.set(node.id, [node.lat, node.lon]));

        const memberWays = relation.members
          .filter((m) => m.type === "way")
          .map((m) =>
            data.elements.find((el) => el.type === "way" && el.id === m.ref)
          )
          .filter(Boolean);

        const wayChains = memberWays.map((way) =>
          way.nodes.map((id) => nodes.get(id)).filter(Boolean)
        );

        const polygons = [];
        while (wayChains.length > 0) {
          let chain = wayChains.shift();
          let extended = true;

          while (extended) {
            extended = false;
            for (let i = 0; i < wayChains.length; i++) {
              const next = wayChains[i];
              const start1 = chain[0], end1 = chain[chain.length - 1];
              const start2 = next[0], end2 = next[next.length - 1];

              const same = (a, b) =>
                Math.abs(a[0] - b[0]) < 0.0001 &&
                Math.abs(a[1] - b[1]) < 0.0001;

              if (same(end1, start2)) {
                chain = [...chain, ...next.slice(1)];
                wayChains.splice(i, 1);
                extended = true;
                break;
              } else if (same(end1, end2)) {
                chain = [...chain, ...next.slice(0, -1).reverse()];
                wayChains.splice(i, 1);
                extended = true;
                break;
              } else if (same(start1, end2)) {
                chain = [...next.slice(0, -1), ...chain];
                wayChains.splice(i, 1);
                extended = true;
                break;
              } else if (same(start1, start2)) {
                chain = [...next.slice(1).reverse(), ...chain];
                wayChains.splice(i, 1);
                extended = true;
                break;
              }
            }
          }

          const first = chain[0];
          const last = chain[chain.length - 1];
          if (
            !(
              Math.abs(first[0] - last[0]) < 0.0001 &&
              Math.abs(first[1] - last[1]) < 0.0001
            )
          ) {
            chain.push(first);
          }

          polygons.push(chain);
        }

        const areas = polygons.map((poly) =>
          turf.area(turf.polygon([poly.map((p) => [p[1], p[0]])]))
        );
        const maxIndex = areas.indexOf(Math.max(...areas));
        const mainPolygon = polygons[maxIndex];

        if (!mainPolygon || mainPolygon.length < 3) {
          throw new Error("Kh√¥ng th·ªÉ t√°i t·∫°o ranh gi·ªõi ch√≠nh x√°c");
        }

        boundaryLayer = L.polygon(mainPolygon, {
          color: APP_CONFIG.boundaryColor,
          weight: APP_CONFIG.boundaryWeight,
          fillColor: APP_CONFIG.boundaryColor,
          fillOpacity: APP_CONFIG.boundaryOpacity,
        }).addTo(map);

        map.fitBounds(boundaryLayer.getBounds());
        hideLoading();
      } catch (error) {
        handleError(error, "createBoundaryFromOSMData");
        createEstimatedBoundary();
      }
    }

    // ========== QU·∫¢N L√ù MARKER ==========
    
    // H√†m th√™m marker v√†o b·∫£n ƒë·ªì
    function addMarkersToMap() {
      MARKERS_DATA.forEach(function(marker, index) {
        const simpleIcon = createSimpleIcon(marker.color);
        
        const markerObj = L.marker(marker.coords, { icon: simpleIcon })
          .addTo(map)
          .on('click', function() {
            showLocationDetails(index);
            map.setView(marker.coords, 14);
          });
          
        markerObjects.push(markerObj);
      });
    }

    // H√†m t·∫°o HTML cho tags
    function createTagsHTML(filters) {
      let tagsHTML = '';
      
      // Tag lo·∫°i h√¨nh
      const typeLabels = {
        'baibien': 'üèñÔ∏è B√£i bi·ªÉn',
        'nghiduong': 'üè® Resort',
        'nhahang': 'üçΩÔ∏è ·∫®m th·ª±c',
        'ditich': 'üèõÔ∏è Di t√≠ch',
        'giaitri': 'üéØ Gi·∫£i tr√≠',
        'muasam': 'üõçÔ∏è Mua s·∫Øm',
        'chua': 'üõï Ch√πa chi·ªÅn',
        'damnuoc': 'üåä ƒê·∫ßm n∆∞·ªõc',
        'suoi': 'üíß Su·ªëi & Th√°c n∆∞·ªõc'
      };
      
      if (typeLabels[filters.type]) {
        tagsHTML += `<div class="location-tag">${typeLabels[filters.type]}</div>`;
      }
      
      // Tag ng√¢n s√°ch
      const budgetLabels = ['üí∞ Mi·ªÖn ph√≠', 'üí∞ Ti·∫øt ki·ªám', 'üí∞ Trung b√¨nh', 'üí∞ Cao c·∫•p', 'üí∞ Luxury'];
      if (budgetLabels[filters.budget]) {
        tagsHTML += `<div class="location-tag">${budgetLabels[filters.budget]}</div>`;
      }
      
      return tagsHTML;
    }

    // H√†m hi·ªÉn th·ªã chi ti·∫øt ƒë·ªãa ƒëi·ªÉm
    function showLocationDetails(index) {
      const marker = MARKERS_DATA[index];
      const infoPanel = document.getElementById('info-panel');
      
      // C·∫≠p nh·∫≠t th√¥ng tin
      document.getElementById('info-image').src = marker.image;
      document.getElementById('info-title').textContent = marker.title;
      document.getElementById('info-description').textContent = marker.description;
      document.getElementById('info-address').textContent = marker.address;
      document.getElementById('info-phone').textContent = marker.phone || "Kh√¥ng c√≥ th√¥ng tin";
      document.getElementById('info-hours').textContent = marker.hours;
      document.getElementById('info-price').textContent = marker.price;
      
      // C·∫≠p nh·∫≠t tags trong info panel
      const infoTags = document.getElementById('info-tags');
      infoTags.innerHTML = createTagsHTML(marker.filters);
      
      // C·∫≠p nh·∫≠t tips v√† l∆∞u √Ω
      updateTipsSection(marker);
      
      // C·∫≠p nh·∫≠t s·ª± ki·ªán cho c√°c n√∫t
      document.getElementById('info-website').onclick = function() {
        if (marker.link && marker.link !== "https://example.com") {
          window.open(marker.link, '_blank');
        } else {
          alert("Kh√¥ng c√≥ th√¥ng tin website cho ƒë·ªãa ƒëi·ªÉm n√†y");
        }
      };
      
      document.getElementById('info-direction').onclick = function() {
        const url = `https://www.google.com/maps/dir/?api=1&destination=${marker.coords[0]},${marker.coords[1]}`;
        window.open(url, '_blank');
      };
      
      // Hi·ªÉn th·ªã panel
      infoPanel.classList.add('active');
    }

    // H√†m c·∫≠p nh·∫≠t ph·∫ßn Tips & L∆∞u √Ω
    function updateTipsSection(marker) {
      const tipsList = document.getElementById('tips-list');
      tipsList.innerHTML = '';
      
      if (marker.tips && marker.tips.length > 0) {
        marker.tips.forEach(tip => {
          const tipItem = document.createElement('li');
          tipItem.className = 'tip-item';
          
          let iconClass = '';
          let iconSymbol = '';
          
          switch(tip.type) {
            case 'tip':
              iconClass = 'tip';
              iconSymbol = 'üí°';
              break;
            case 'warning':
              iconClass = 'warning';
              iconSymbol = '‚ö†Ô∏è';
              break;
            case 'info':
              iconClass = 'info';
              iconSymbol = '‚ÑπÔ∏è';
              break;
            default:
              iconClass = 'info';
              iconSymbol = '‚ÑπÔ∏è';
          }
          
          tipItem.innerHTML = `
            <div class="tip-icon ${iconClass}">${iconSymbol}</div>
            <div class="tip-content">
              <div class="tip-title">${tip.title}</div>
              <div class="tip-text">${tip.text}</div>
            </div>
          `;
          
          tipsList.appendChild(tipItem);
        });
        
        // Hi·ªÉn th·ªã section tips
        document.getElementById('tips-content').classList.remove('collapsed');
        document.getElementById('tips-toggle').classList.add('rotated');
      } else {
        // ·∫®n section tips n·∫øu kh√¥ng c√≥ tips
        document.getElementById('tips-content').classList.add('collapsed');
        document.getElementById('tips-toggle').classList.remove('rotated');
      }
    }

    // ========== X·ª¨ L√ù S·ª∞ KI·ªÜN ==========
    
    // H√†m thi·∫øt l·∫≠p toggle cho tips section
    function setupTipsToggle() {
      const tipsHeader = document.getElementById('tips-header');
      const tipsContent = document.getElementById('tips-content');
      const tipsToggle = document.getElementById('tips-toggle');
      
      tipsHeader.addEventListener('click', function() {
        tipsContent.classList.toggle('collapsed');
        tipsToggle.classList.toggle('rotated');
      });
    }

    // X·ª≠ l√Ω s·ª± ki·ªán ƒë√≥ng info panel
    function setupInfoPanel() {
      document.getElementById('info-close').addEventListener('click', function() {
        document.getElementById('info-panel').classList.remove('active');
      });
    }

    // X·ª≠ l√Ω s·ª± ki·ªán c√°c n√∫t ƒëi·ªÅu khi·ªÉn b·∫£n ƒë·ªì
    function setupMapControls() {
      // N√∫t locate me
      document.getElementById('locate-me').addEventListener('click', function() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            const latlng = L.latLng(position.coords.latitude, position.coords.longitude);
            map.setView(latlng, 14);
            L.marker(latlng)
              .addTo(map)
              .bindPopup("V·ªã tr√≠ c·ªßa b·∫°n")
              .openPopup();
          }, function(error) {
            alert("Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠ c·ªßa b·∫°n: " + error.message);
          });
        } else {
          alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã");
        }
      });

      // N√∫t toggle boundary
      document.getElementById('toggle-boundary').addEventListener('click', function() {
        if (boundaryLayer) {
          if (boundaryVisible) {
            map.removeLayer(boundaryLayer);
          } else {
            map.addLayer(boundaryLayer);
          }
          boundaryVisible = !boundaryVisible;
        }
      });

      // N√∫t toggle satellite
      document.getElementById('toggle-satellite').addEventListener('click', function() {
        if (isSatellite) {
          map.removeLayer(satelliteLayer);
          map.addLayer(osmLayer);
        } else {
          map.removeLayer(osmLayer);
          map.addLayer(satelliteLayer);
        }
        isSatellite = !isSatellite;
      });

      // N√∫t fullscreen
      document.getElementById('fullscreen').addEventListener('click', function() {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen();
          this.innerHTML = '<i class="fas fa-compress"></i>';
        } else {
          if (document.exitFullscreen) {
            document.exitFullscreen();
            this.innerHTML = '<i class="fas fa-expand"></i>';
          }
        }
      });
    }

    // Thi·∫øt l·∫≠p n√∫t ·∫©n/hi·ªán ch√∫ th√≠ch
    function setupLegendToggle() {
      const legendToggle = document.getElementById('legend-toggle');
      const legendShow = document.getElementById('legend-show');
      const legend = document.getElementById('legend');
      
      legendToggle.addEventListener('click', function() {
        legendVisible = !legendVisible;
        
        if (legendVisible) {
          legend.classList.remove('hidden');
          legendShow.classList.remove('visible');
          legendToggle.innerHTML = '<i class="fas fa-eye-slash"></i>';
        } else {
          legend.classList.add('hidden');
          legendShow.classList.add('visible');
          legendToggle.innerHTML = '<i class="fas fa-eye"></i>';
        }
        
        // L∆∞u t√πy ch·ªçn v√†o localStorage
        localStorage.setItem('legendVisible', legendVisible);
      });
      
      // N√∫t hi·ªán ch√∫ th√≠ch
      legendShow.addEventListener('click', function() {
        legendVisible = true;
        legend.classList.remove('hidden');
        legendShow.classList.remove('visible');
        legendToggle.innerHTML = '<i class="fas fa-eye-slash"></i>';
        
        // L∆∞u t√πy ch·ªçn v√†o localStorage
        localStorage.setItem('legendVisible', legendVisible);
      });
      
      // Ki·ªÉm tra localStorage
      const savedLegendVisible = localStorage.getItem('legendVisible');
      if (savedLegendVisible !== null) {
        legendVisible = savedLegendVisible === 'true';
        if (!legendVisible) {
          legend.classList.add('hidden');
          legendShow.classList.add('visible');
          legendToggle.innerHTML = '<i class="fas fa-eye"></i>';
        }
      }
    }

    // ========== KH·ªûI T·∫†O ·ª®NG D·ª§NG ==========
    
    // H√†m kh·ªüi t·∫°o ·ª©ng d·ª•ng
    function initApp() {
      // G·ªçi d·ªØ li·ªáu OSM ƒë·ªÉ t·∫°o ranh gi·ªõi
      fetch(`https://overpass-api.de/api/interpreter?data=[out:json];relation(${APP_CONFIG.osmRelationId});(._;>;);out;`)
        .then((res) => res.json())
        .then(createBoundaryFromOSMData)
        .catch((err) => {
          handleError(err, "fetch OSM data");
          createEstimatedBoundary();
        });

      // Th√™m marker v√†o b·∫£n ƒë·ªì
      addMarkersToMap();
      
      // Thi·∫øt l·∫≠p c√°c s·ª± ki·ªán
      setupTipsToggle();
      setupInfoPanel();
      setupMapControls();
      setupLegendToggle();
      
      // ·∫®n loading sau khi t·∫£i xong
      setTimeout(hideLoading, 1000);
    }

    // Kh·ªüi ch·∫°y ·ª©ng d·ª•ng khi DOM ƒë√£ s·∫µn s√†ng
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>