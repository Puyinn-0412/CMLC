<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bản đồ Chân Mây - Lăng Cô</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Turf.js để tính diện tích polygon -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* Reset và base styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow: hidden;
    }

    #map {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }

    /* Sidebar styles */
    .sidebar {
      position: absolute;
      top: 0;
      left: 0;
      width: 420px;
      height: 100%;
      background: white;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      z-index: 10;
      transition: transform 0.3s ease;
      overflow-y: auto;
    }

    .sidebar.collapsed {
      transform: translateX(-100%);
    }

    .sidebar-toggle {
      position: absolute;
      top: 15px;
      right: -45px;
      width: 40px;
      height: 40px;
      background: white;
      border: none;
      border-radius: 50%;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 11;
    }

    .sidebar-content {
      padding: 20px;
    }

    .sidebar-header {
      margin-bottom: 20px;
    }

    .sidebar-header h1 {
      font-size: 24px;
      color: #2d3748;
      margin-bottom: 5px;
    }

    .sidebar-header p {
      color: #718096;
      font-size: 14px;
    }

    .search-box {
      position: relative;
      margin-bottom: 20px;
    }

    .search-box input {
      width: 100%;
      padding: 12px 15px 12px 40px;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.3s;
    }

    .search-box input:focus {
      outline: none;
      border-color: #4299e1;
      box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
    }

    .search-box i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #a0aec0;
    }

    /* Filter sections */
    .filter-section {
      margin-bottom: 20px;
      background: #f8fafc;
      border-radius: 12px;
      padding: 15px;
    }

    .filter-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      cursor: pointer;
    }

    .filter-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      color: #2d3748;
      font-size: 15px;
    }

    .filter-toggle {
      background: none;
      border: none;
      color: #718096;
      cursor: pointer;
      transition: transform 0.3s;
    }

    .filter-toggle.rotated {
      transform: rotate(180deg);
    }

    .filter-content {
      display: block;
    }

    .filter-content.collapsed {
      display: none;
    }

    .filter-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .filter-tag {
      background: white;
      border: 1px solid #e2e8f0;
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 13px;
      color: #4a5568;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .filter-tag:hover {
      background: #edf2f7;
    }

    .filter-tag.active {
      background: #4299e1;
      color: white;
      border-color: #4299e1;
    }

    .budget-slider {
      width: 100%;
      margin: 10px 0;
    }

    .budget-labels {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #718096;
      margin-top: 5px;
    }

    .time-slider {
      width: 100%;
      margin: 10px 0;
    }

    .time-labels {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #718096;
      margin-top: 5px;
    }

    .age-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .age-btn {
      padding: 8px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 13px;
      text-align: center;
    }

    .age-btn:hover {
      background: #edf2f7;
    }

    .age-btn.active {
      background: #4299e1;
      color: white;
      border-color: #4299e1;
    }

    .clear-filters {
      width: 100%;
      padding: 12px;
      background: #e53e3e;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
      margin-top: 10px;
    }

    .clear-filters:hover {
      background: #c53030;
    }

    .location-list {
      list-style: none;
    }

    .location-item {
      display: flex;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.3s;
      border: 1px solid transparent;
    }

    .location-item:hover {
      background: #f7fafc;
      border-color: #e2e8f0;
    }

    .location-item.active {
      background: #ebf8ff;
      border-color: #4299e1;
    }

    .location-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      margin-right: 15px;
      flex-shrink: 0;
    }

    .location-content {
      flex: 1;
    }

    .location-content .location-title {
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 5px;
    }

    .location-content .location-desc {
      font-size: 13px;
      color: #718096;
      line-height: 1.4;
    }

    .location-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 8px;
    }

    .location-tag {
      background: #edf2f7;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      color: #4a5568;
    }

    /* Info Panel styles */
    .info-panel {
      position: absolute;
      top: 0;
      right: -400px;
      width: 400px;
      height: 100%;
      background: white;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      z-index: 10;
      transition: right 0.3s ease;
      overflow-y: auto;
    }

    .info-panel.active {
      right: 0;
    }

    .info-header {
      position: relative;
      height: 200px;
      overflow: hidden;
    }

    .info-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .info-close {
      position: absolute;
      top: 15px;
      right: 15px;
      width: 40px;
      height: 40px;
      background: rgba(0, 0, 0, 0.5);
      border: none;
      border-radius: 50%;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .info-content {
      padding: 20px;
    }

    .info-title {
      font-size: 22px;
      color: #2d3748;
      margin-bottom: 10px;
    }

    .info-description {
      color: #718096;
      line-height: 1.6;
      margin-bottom: 20px;
    }

    .info-details {
      margin-bottom: 20px;
    }

    .info-detail {
      display: flex;
      margin-bottom: 10px;
      align-items: flex-start;
    }

    .info-detail i {
      width: 20px;
      margin-right: 10px;
      color: #4299e1;
      margin-top: 2px;
    }

    .info-detail strong {
      color: #4a5568;
      margin-right: 5px;
    }

    .info-detail span {
      color: #718096;
    }

    .info-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 15px 0;
    }

    .info-tag {
      background: #ebf8ff;
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 12px;
      color: #2b6cb0;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .info-actions {
      display: flex;
      gap: 10px;
    }

    .info-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.3s;
    }

    .info-btn.primary {
      background: #4299e1;
      color: white;
    }

    .info-btn.primary:hover {
      background: #3182ce;
    }

    .info-btn.secondary {
      background: #e2e8f0;
      color: #4a5568;
    }

    .info-btn.secondary:hover {
      background: #cbd5e0;
    }

    /* Map Controls */
    .map-controls {
      position: absolute;
      bottom: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 5;
    }

    .map-control {
      width: 50px;
      height: 50px;
      background: white;
      border: none;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #4a5568;
      transition: all 0.3s;
    }

    .map-control:hover {
      background: #f7fafc;
      color: #4299e1;
    }

    /* Legend */
    .legend {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      z-index: 5;
      max-width: 250px;
    }

    .legend h4 {
      margin-bottom: 10px;
      color: #2d3748;
      font-size: 16px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }

    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      margin-right: 10px;
      border: 2px solid;
    }

    .boundary-color {
      background: rgba(52, 152, 219, 0.2);
      border-color: #3498db;
    }

    /* Loading indicator */
    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px 30px;
      border-radius: 10px;
      box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
      z-index: 100;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .loading-spinner {
      width: 30px;
      height: 30px;
      border: 3px solid #e2e8f0;
      border-top: 3px solid #4299e1;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsive styles */
    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        max-width: 320px;
      }
      
      .info-panel {
        width: 100%;
        max-width: 320px;
        right: -320px;
      }
      
      .legend {
        max-width: 200px;
        bottom: 80px;
      }
      
      .map-controls {
        bottom: 20px;
        right: 10px;
      }
    }

    /* Override Leaflet popup styles */
    .leaflet-popup-content-wrapper {
      padding: 0 !important;
      border-radius: 20px !important;
      overflow: hidden !important;
      background: white !important;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3) !important;
    }

    .leaflet-popup-content {
      margin: 0 !important;
      width: 360px !important;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
    }

    .leaflet-popup-close-btn {
      display: none !important;
    }

    .leaflet-popup-tip {
      display: none !important;
    }

    .popup-container-custom {
      width: 100%;
      background: white;
    }

    .popup-header {
      background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
      padding: 18px 20px;
      position: relative;
      color: white;
    }

    .close-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      font-size: 20px;
      color: white;
      cursor: pointer;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      line-height: 1;
    }

    .location-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 17px;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .icon {
      font-size: 18px;
    }

    .city-badge {
      display: inline-block;
      background: rgba(14, 165, 233, 0.95);
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      margin-top: 8px;
    }

    .tags-section {
      margin: 16px 18px;
      padding: 14px;
      background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
      border-radius: 12px;
    }

    .tags-title {
      display: flex;
      align-items: center;
      gap: 6px;
      color: #0369a1;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .tags-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .tag {
      background: white;
      border: 2px solid transparent;
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 12px;
      color: #4a5568;
      font-weight: 500;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .tag.highlight {
      background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
      color: white;
      font-weight: 600;
    }

    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      padding: 0 18px 16px 18px;
    }

    .info-card {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      padding: 14px;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      position: relative;
      overflow: hidden;
    }

    .info-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--accent-color);
    }

    .info-card.green { --accent-color: linear-gradient(90deg, #0891b2, #06b6d4); }
    .info-card.purple { --accent-color: linear-gradient(90deg, #3b82f6, #60a5fa); }
    .info-card.pink { --accent-color: linear-gradient(90deg, #0ea5e9, #38bdf8); }
    .info-card.orange { --accent-color: linear-gradient(90deg, #14b8a6, #2dd4bf); }

    .info-label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 6px;
      text-transform: uppercase;
    }

    .info-value {
      font-size: 16px;
      font-weight: 700;
    }

    .info-card.green .info-value { color: #0891b2; }
    .info-card.purple .info-value { color: #3b82f6; }
    .info-card.pink .info-value { color: #0ea5e9; }
    .info-card.orange .info-value { color: #14b8a6; }

    .admin-section {
      padding: 16px 18px;
      background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
      margin: 0 18px 16px 18px;
      border-radius: 12px;
    }

    .admin-title {
      display: flex;
      align-items: center;
      gap: 6px;
      color: #0369a1;
      font-size: 12px;
      font-weight: 700;
      margin-bottom: 6px;
      text-transform: uppercase;
    }

    .admin-value {
      font-size: 13px;
      color: #334155;
      font-weight: 500;
      line-height: 1.6;
    }

    .footer-section {
      padding: 14px 18px 16px 18px;
      text-align: center;
      color: #64748b;
      font-size: 12px;
      line-height: 1.6;
      background: #f8fafc;
    }

    .footer-location {
      font-weight: 500;
      color: #475569;
      margin-bottom: 4px;
    }

    .osm-id {
      color: #94a3b8;
      font-size: 12px;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  
  <!-- Loading indicator -->
  <div class="loading" id="loading">
    <div class="loading-spinner"></div>
    <span>Đang tải bản đồ...</span>
  </div>
  
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <button class="sidebar-toggle" id="sidebar-toggle">
      <i class="fas fa-bars"></i>
    </button>
    
    <div class="sidebar-content">
      <div class="sidebar-header">
        <h1>🌊 Chân Mây - Lăng Cô</h1>
        <p>Khám phá các điểm du lịch tuyệt vời</p>
      </div>
      
      <div class="search-box">
        <input type="text" id="search-input" placeholder="Tìm kiếm địa điểm...">
        <i class="fas fa-search"></i>
      </div>
      
      <!-- Bộ lọc loại hình -->
      <div class="filter-section">
        <div class="filter-header" id="type-filter-header">
          <div class="filter-title">
            <i class="fas fa-filter"></i>
            <span>Loại hình</span>
          </div>
          <button class="filter-toggle" id="type-filter-toggle">
            <i class="fas fa-chevron-down"></i>
          </button>
        </div>
        <div class="filter-content" id="type-filter-content">
          <div class="filter-tags">
            <div class="filter-tag" data-type="baibien">
              <i class="fas fa-umbrella-beach"></i>
              <span>Bãi biển</span>
            </div>
            <div class="filter-tag" data-type="nghiduong">
              <i class="fas fa-hotel"></i>
              <span>Resort & Khách sạn</span>
            </div>
            <div class="filter-tag" data-type="nhahang">
              <i class="fas fa-utensils"></i>
              <span>Nhà hàng & Ẩm thực</span>
            </div>
            <div class="filter-tag" data-type="ditich">
              <i class="fas fa-landmark"></i>
              <span>Di tích lịch sử</span>
            </div>
            <div class="filter-tag" data-type="giaitri">
              <i class="fas fa-gamepad"></i>
              <span>Giải trí</span>
            </div>
            <div class="filter-tag" data-type="muasam">
              <i class="fas fa-shopping-bag"></i>
              <span>Mua sắm</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Bộ lọc tiêu chí -->
      <div class="filter-section">
        <div class="filter-header" id="criteria-filter-header">
          <div class="filter-title">
            <i class="fas fa-star"></i>
            <span>Tiêu chí</span>
          </div>
          <button class="filter-toggle" id="criteria-filter-toggle">
            <i class="fas fa-chevron-down"></i>
          </button>
        </div>
        <div class="filter-content" id="criteria-filter-content">
          <!-- Phù hợp gia đình -->
          <div style="margin-bottom: 15px;">
            <div style="font-weight: 600; margin-bottom: 8px; color: #2d3748;">Phù hợp</div>
            <div class="filter-tags">
              <div class="filter-tag" data-criteria="family">
                <i class="fas fa-users"></i>
                <span>Gia đình</span>
              </div>
              <div class="filter-tag" data-criteria="couple">
                <i class="fas fa-heart"></i>
                <span>Lãng mạn</span>
              </div>
              <div class="filter-tag" data-criteria="solo">
                <i class="fas fa-user"></i>
                <span>Đi một mình</span>
              </div>
            </div>
          </div>
          
          <!-- Ngân sách -->
          <div style="margin-bottom: 15px;">
            <div style="font-weight: 600; margin-bottom: 8px; color: #2d3748;">Ngân sách</div>
            <input type="range" min="0" max="4" value="4" class="budget-slider" id="budget-slider">
            <div class="budget-labels">
              <span>Miễn phí</span>
              <span>Tiết kiệm</span>
              <span>Trung bình</span>
              <span>Cao cấp</span>
              <span>Luxury</span>
            </div>
          </div>
          
          <!-- Độ tuổi -->
          <div style="margin-bottom: 15px;">
            <div style="font-weight: 600; margin-bottom: 8px; color: #2d3748;">Độ tuổi</div>
            <div class="age-buttons">
              <button class="age-btn" data-age="all">Tất cả</button>
              <button class="age-btn" data-age="child">Trẻ em</button>
              <button class="age-btn" data-age="teen">Thanh thiếu niên</button>
              <button class="age-btn" data-age="adult">Người lớn</button>
              <button class="age-btn" data-age="senior">Người cao tuổi</button>
            </div>
          </div>
          
          <!-- Thời gian tham quan -->
          <div>
            <div style="font-weight: 600; margin-bottom: 8px; color: #2d3748;">Thời gian tham quan</div>
            <input type="range" min="0" max="4" value="4" class="time-slider" id="time-slider">
            <div class="time-labels">
              <span>Dưới 1h</span>
              <span>1-2h</span>
              <span>2-4h</span>
              <span>Nửa ngày</span>
              <span>Cả ngày</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Nút xóa bộ lọc -->
      <button class="clear-filters" id="clear-filters">
        <i class="fas fa-times"></i>
        Xóa tất cả bộ lọc
      </button>
      
      <h3 style="margin: 20px 0 15px; color: #2d3748;">Địa điểm nổi bật</h3>
      <ul class="location-list" id="location-list">
        <!-- Danh sách địa điểm sẽ được thêm bằng JavaScript -->
      </ul>
    </div>
  </div>
  
  <!-- Info Panel -->
  <div class="info-panel" id="info-panel">
    <div class="info-header">
      <img id="info-image" src="" alt="" class="info-image">
      <button class="info-close" id="info-close">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="info-content">
      <h2 class="info-title" id="info-title"></h2>
      <p class="info-description" id="info-description"></p>
      
      <!-- Tags trong info panel -->
      <div class="info-tags" id="info-tags">
        <!-- Tags sẽ được thêm bằng JavaScript -->
      </div>
      
      <div class="info-details">
        <div class="info-detail">
          <i class="fas fa-map-marker-alt"></i>
          <strong>Địa chỉ:</strong> <span id="info-address"></span>
        </div>
        <div class="info-detail">
          <i class="fas fa-phone"></i>
          <strong>Điện thoại:</strong> <span id="info-phone"></span>
        </div>
        <div class="info-detail">
          <i class="fas fa-clock"></i>
          <strong>Giờ mở cửa:</strong> <span id="info-hours"></span>
        </div>
        <div class="info-detail">
          <i class="fas fa-tag"></i>
          <strong>Giá vé:</strong> <span id="info-price"></span>
        </div>
      </div>
      
      <div class="info-actions">
        <button class="info-btn secondary" id="info-direction">
          <i class="fas fa-route"></i> Chỉ đường
        </button>
        <button class="info-btn primary" id="info-website">
          <i class="fas fa-external-link-alt"></i> Website
        </button>
      </div>
    </div>
  </div>
  
  <!-- Map Controls -->
  <div class="map-controls">
    <button class="map-control" id="locate-me" title="Vị trí của tôi">
      <i class="fas fa-location-arrow"></i>
    </button>
    <button class="map-control" id="toggle-boundary" title="Ranh giới">
      <i class="fas fa-draw-polygon"></i>
    </button>
    <button class="map-control" id="toggle-satellite" title="Chế độ vệ tinh">
      <i class="fas fa-satellite"></i>
    </button>
    <button class="map-control" id="fullscreen" title="Toàn màn hình">
      <i class="fas fa-expand"></i>
    </button>
  </div>
  
  <!-- Legend -->
  <div class="legend">
    <h4>Chú thích</h4>
    <div class="legend-item">
      <div class="legend-color boundary-color"></div>
      <span>Ranh giới khu vực</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #e74c3c; border-color: #c0392b;"></div>
      <span>Di tích lịch sử</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #3498db; border-color: #2980b9;"></div>
      <span>Bãi biển & Đầm nước</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #27ae60; border-color: #219a52;"></div>
      <span>Suối & Thác nước</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #f39c12; border-color: #e67e22;"></div>
      <span>Khu nghỉ dưỡng</span>
    </div>
  </div>

  <script>
    // ========== CẤU TRÚC DỮ LIỆU VÀ CẤU HÌNH ==========
    
    // Cấu hình ứng dụng
    const APP_CONFIG = {
      mapCenter: [16.27, 108.06],
      defaultZoom: 12,
      osmRelationId: 19325212,
      boundaryColor: "#3498db",
      boundaryOpacity: 0.15,
      boundaryWeight: 3
    };

    // Dữ liệu các điểm đánh dấu với thông tin lọc nâng cao
    const MARKERS_DATA = [
      {
        id: 1,
        coords: [16.187768367009422, 108.13129996298079],
        title: "Hải Vân Quan",
        description: "Di tích lịch sử nổi tiếng nằm trên đỉnh đèo Hải Vân, từng là cửa ngõ quan trọng giữa Thừa Thiên Huế và Đà Nẵng.",
        image: "https://images.unsplash.com/photo-1507525428034-b723cf961d3e?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=600&q=80",
        category: "ditich",
        color: "#e74c3c",
        link: "https://www.google.com/maps/place/H%E1%BA%A3i+V%C3%A2n+Quan/@16.1877377,108.1287193,836m/data=!3m2!1e3!4b1!4m6!3m5!1s0x3142219e02bc568b:0xb04a3eba486386b5!8m2!3d16.1877377!4d108.1312942!16s%2Fg%2F11p5lgqrq9?hl=vi&entry=ttu&g_ep=EgoyMDI1MTAwOC4wIKXMDSoASAFQAw%3D%3D",
        address: "Đèo Hải Vân, giáp ranh Thành phố Huế và Đà Nẵng",
        phone: "0234 123 456",
        hours: "Mở cửa cả ngày",
        price: "Miễn phí",
        // Thông tin lọc nâng cao
        filters: {
          type: "ditich",
          suitability: ["family", "couple", "solo"],
          budget: 0, // 0: Miễn phí, 1: Tiết kiệm, 2: Trung bình, 3: Cao cấp, 4: Luxury
          age: ["child", "teen", "adult", "senior"],
          time: 1 // 0: Dưới 1h, 1: 1-2h, 2: 2-4h, 3: Nửa ngày, 4: Cả ngày
        }
      },
      {
        id: 2,
        coords: [16.227258827040963, 108.07544107963488],
        title: "Đầm Lập An",
        description: "Đầm nước mặn rộng lớn với hệ sinh thái đa dạng, nổi tiếng với nghề nuôi hàu và cảnh quan thiên nhiên tuyệt đẹp.",
        image: "https://upload.wikimedia.org/wikipedia/commons/c/c9/Laguna_Lap_An%2C_Provincia_de_Thua_Thien-Hue%2C_Vietnam.jpg",
        category: "damnuoc",
        color: "#3498db",
        link: "https://example.com/dam-lap-an",
        address: "Xã Chân Mây Lăng Cô, Thành phố Huế",
        phone: "",
        hours: "Mở cả ngày",
        price: "Miễn phí",
        filters: {
          type: "baibien",
          suitability: ["family", "couple", "solo"],
          budget: 0,
          age: ["child", "teen", "adult", "senior"],
          time: 2
        }
      },
      {
        id: 3,
        coords: [16.31724163145726, 107.97717739551304],
        title: "Bãi biển Tân Cảnh Dương",
        description: "Bãi biển hoang sơ với cát trắng và nước trong xanh, lý tưởng cho những ai yêu thích sự yên tĩnh và thiên nhiên.",
        image: "https://images.unsplash.com/photo-1534430480872-3498386e7856?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=600&q=80",
        category: "baibien",
        color: "#3498db",
        link: "https://example.com/tan-canh-duong",
        address: "Xã Chân Mây Lăng Cô, Thành phố Huế",
        phone: "0234 123 458",
        hours: "Mở cửa cả ngày",
        price: "Miễn phí",
        filters: {
          type: "baibien",
          suitability: ["family", "couple", "solo"],
          budget: 0,
          age: ["child", "teen", "adult", "senior"],
          time: 3
        }
      },
      {
        id: 4,
        coords: [16.31296999941014, 108.00091933765658],
        title: "Bãi biển Bình An",
        description: "Bãi biển đẹp với bãi cát trắng trải dài, nước biển trong xanh, thích hợp cho các hoạt động tắm biển và thể thao dưới nước.",
        image: "https://images.unsplash.com/photo-1544551763-46a013bb70d5?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=600&q=80",
        category: "baibien",
        color: "#3498db",
        link: "https://example.com/binh-an",
        address: "Xã Chân Mây Lăng Cô, Thành phố Huế",
        phone: "0234 123 459",
        hours: "Mở cửa cả ngày",
        price: "Miễn phí",
        filters: {
          type: "baibien",
          suitability: ["family", "couple", "solo"],
          budget: 0,
          age: ["child", "teen", "adult", "senior"],
          time: 3
        }
      },
      {
        id: 5,
        coords: [16.265680775230162, 108.06610813578524],
        title: "Bãi biển Lăng Cô",
        description: "Một trong những bãi biển đẹp nhất Việt Nam, được công nhận là vịnh đẹp thế giới với cảnh quan thiên nhiên hùng vĩ.",
        image: "https://images.unsplash.com/photo-1597075882936-27bfa7357b3c?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=600&q=80",
        category: "baibien",
        color: "#3498db",
        link: "https://example.com/lang-co",
        address: "Xã Chân Mây Lăng Cô, Thành phố Huế",
        phone: "0234 123 460",
        hours: "Mở cửa cả ngày",
        price: "Miễn phí",
        filters: {
          type: "baibien",
          suitability: ["family", "couple", "solo"],
          budget: 0,
          age: ["child", "teen", "adult", "senior"],
          time: 4
        }
      },
      {
        id: 6,
        coords: [16.24402108899415, 107.98933957990741],
        title: "Suối Voi",
        description: "Dòng suối trong lành chảy qua những tảng đá lớn hình voi, tạo nên khung cảnh thiên nhiên độc đáo và thơ mộng.",
        image: "https://images.unsplash.com/photo-1574269909862-7e1d70bb8078?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=600&q=80",
        category: "suoi",
        color: "#27ae60",
        link: "https://example.com/suoi-voi",
        address: "Xã Chân Mây Lăng Cô, Thành phố Huế",
        phone: "0234 123 461",
        hours: "Mở cửa cả ngày",
        price: "Miễn phí",
        filters: {
          type: "giaitri",
          suitability: ["family", "couple", "solo"],
          budget: 0,
          age: ["child", "teen", "adult", "senior"],
          time: 2
        }
      },
      {
        id: 7,
        coords: [16.253183945484594, 107.99086924102949],
        title: "Suối Bầu Ghè",
        description: "Dòng suối mát lành với nhiều thác nước nhỏ, là điểm đến lý tưởng cho những chuyến picnic và khám phá thiên nhiên.",
        image: "https://images.unsplash.com/photo-1551632811-561732d1e306?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=600&q=80",
        category: "suoi",
        color: "#27ae60",
        link: "https://example.com/suoi-bau-ghe",
        address: "Xã Chân Mây Lăng Cô, Thành phố Huế",
        phone: "0234 123 462",
        hours: "Mở cửa cả ngày",
        price: "Miễn phí",
        filters: {
          type: "giaitri",
          suitability: ["family", "couple", "solo"],
          budget: 0,
          age: ["child", "teen", "adult", "senior"],
          time: 2
        }
      },
      {
        id: 8,
        coords: [16.24465135364992, 107.9320540367809],
        title: "Suối Tiên",
        description: "Dòng suối với vẻ đẹp như chốn thần tiên, nước trong vắt chảy qua những phiến đá tự nhiên tạo thành các bậc thang độc đáo.",
        image: "https://images.unsplash.com/photo-1439066615861-d1af74d74000?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=600&q=80",
        category: "suoi",
        color: "#27ae60",
        link: "https://example.com/suoi-tien",
        address: "Xã Chân Mây Lăng Cô, Thành phố Huế",
        phone: "0234 123 463",
        hours: "Mở cửa cả ngày",
        price: "Miễn phí",
        filters: {
          type: "giaitri",
          suitability: ["family", "couple", "solo"],
          budget: 0,
          age: ["child", "teen", "adult", "senior"],
          time: 2
        }
      },
      {
        id: 9,
        coords: [16.200864938077345, 108.13337584408814],
        title: "Đèo Hải Vân",
        description: "Đèo Hải Vân nằm giữa Thừa Thiên Huế và Đà Nẵng, được mệnh danh là 'Thiên hạ đệ nhất hùng quan' với cảnh quan thiên nhiên hùng vĩ.",
        image: "https://images.unsplash.com/photo-1597075882936-27bfa7357b3c?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=600&q=80",
        category: "ditich",
        color: "#e74c3c",
        link: "https://www.google.com/maps/place/%C4%90%C3%A8o+H%E1%BA%A3i+V%C3%A2n/@16.1999995,108.1230332,3345m/data=!3m2!1e3!4b1!4m6!3m5!1s0x31422151a4984555:0x9a66217b26b3f759!8m2!3d16.2!4d108.133333!16s%2Fm%2F02rnk9y?hl=vi&entry=ttu&g_ep=EgoyMDI1MTAwOC4wIKXMDSoASAFQAw%3D%3D",
        address: "Xã Chân Mây Lăng Cô, Thành phố Huế",
        phone: "0234 123 464",
        hours: "Mở cửa cả ngày",
        price: "Miễn phí",
        filters: {
          type: "ditich",
          suitability: ["family", "couple", "solo"],
          budget: 0,
          age: ["child", "teen", "adult", "senior"],
          time: 1
        }
      },
      {
        id: 10,
        coords: [16.32695564023601, 107.95730352364052],
        title: "Laguna Lăng Cô",
        description: "Khu nghỉ dưỡng cao cấp với đầy đủ tiện nghi, nằm bên bờ biển Lăng Cô thơ mộng, lý tưởng cho kỳ nghỉ sang trọng.",
        image: "https://ygt-res.cloudinary.com/image/upload/c_fit,h_1280,q_80,w_1920/v1614090904/Venues/Laguna%20Lang%20Co%20Golf%20Club/laguna-lang-co-golf-club-1.jpg",
        category: "nghiduong",
        color: "#f39c12",
        link: "https://example.com/laguna-lang-co",
        address: "Xã Chân Mây Lăng Cô, Thành phố Huế",
        phone: "02343695800",
        hours: "Mở cửa cả ngày",
        price: "Từ 2.500.000 VNĐ/đêm",
        filters: {
          type: "nghiduong",
          suitability: ["family", "couple"],
          budget: 4,
          age: ["adult"],
          time: 4
        }
      },
      {
        id: 11,
        coords: [16.216834383654582, 108.02855192753158],
        title: "Suối Mơ",
        description: "Dòng suối thơ mộng với cảnh quan thiên nhiên tươi đẹp, là điểm đến lý tưởng cho những ai yêu thích sự yên bình.",
        image:"https://upload.wikimedia.org/wikipedia/commons/b/b6/Suoi_Mo-Dream_Creek.jpg",
        category: "suoi",
        color: "#27ae60",
        link: "https://example.com/suoi-mo",
        address: "Xã Chân Mây Lăng Cô, Thành phố Huế",
        phone: "0934194621",
        hours: "Mở cửa cả ngày",
        price: "Miễn phí",
        filters: {
          type: "giaitri",
          suitability: ["family", "couple", "solo"],
          budget: 0,
          age: ["child", "teen", "adult", "senior"],
          time: 2
        }
      },
      {
        id: 12,
        coords: [16.275, 108.085],
        title: "Nhà hàng Hải Sản Lăng Cô",
        description: "Nhà hàng chuyên phục vụ hải sản tươi sống với view biển tuyệt đẹp.",
        image: "https://images.unsplash.com/photo-1414235077428-338989a2e8c0?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=600&q=80",
        category: "nhahang",
        color: "#9b59b6",
        link: "https://example.com/nha-hang-hai-san",
        address: "Xã Chân Mây Lăng Cô, Thành phố Huế",
        phone: "0234 123 465",
        hours: "10:00 - 22:00",
        price: "150.000 - 500.000 VNĐ",
        filters: {
          type: "nhahang",
          suitability: ["family", "couple"],
          budget: 2,
          age: ["teen", "adult", "senior"],
          time: 1
        }
      },
      {
        id: 13,
        coords: [16.285, 108.095],
        title: "Chợ Đêm Lăng Cô",
        description: "Khu chợ đêm sầm uất với nhiều mặt hàng đặc sản và quà lưu niệm.",
        image: "https://images.unsplash.com/photo-1556909114-f6e7ad7d3136?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=600&q=80",
        category: "muasam",
        color: "#e67e22",
        link: "https://example.com/cho-dem",
        address: "Xã Chân Mây Lăng Cô, Thành phố Huế",
        phone: "",
        hours: "17:00 - 23:00",
        price: "Miễn phí vào cửa",
        filters: {
          type: "muasam",
          suitability: ["family", "couple", "solo"],
          budget: 1,
          age: ["child", "teen", "adult", "senior"],
          time: 1
        }
      }
    ];

    // ========== KHỞI TẠO ỨNG DỤNG ==========
    
    // Khởi tạo bản đồ
    const map = L.map("map").setView(APP_CONFIG.mapCenter, APP_CONFIG.defaultZoom);

    // Thêm lớp bản đồ
    const osmLayer = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 18,
      attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
    }).addTo(map);

    // Thêm lớp bản đồ vệ tinh
    const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
      maxZoom: 18
    });

    // Biến toàn cục
    let boundaryLayer;
    let boundaryVisible = true;
    let isSatellite = false;
    let markerObjects = [];
    let currentMarkerIndex = -1;
    
    // Biến lưu trạng thái bộ lọc
    let activeFilters = {
      type: null,
      suitability: [],
      budget: 4, // Mặc định: tất cả các mức giá
      age: "all", // Mặc định: tất cả độ tuổi
      time: 4 // Mặc định: tất cả thời gian
    };

    // ========== HÀM TIỆN ÍCH ==========
    
    // Hàm tạo icon marker
    function createSimpleIcon(color) {
      return L.divIcon({
        className: 'simple-marker',
        html: `<div style="background-color: ${color}; width: 24px; height: 24px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.5);"></div>`,
        iconSize: [24, 24],
        iconAnchor: [12, 24]
      });
    }

    // Hàm ẩn loading indicator
    function hideLoading() {
      const loading = document.getElementById('loading');
      loading.style.display = 'none';
    }

    // Hàm xử lý lỗi
    function handleError(error, context) {
      console.error(`Lỗi trong ${context}:`, error);
    }

    // ========== QUẢN LÝ RANH GIỚI ==========
    
    // Hàm tạo ranh giới ước lượng
    function createEstimatedBoundary() {
      const coords = [
        [16.26, 108.00],
        [16.25, 108.10],
        [16.20, 108.12],
        [16.18, 108.06],
        [16.21, 108.00],
      ];
      
      boundaryLayer = L.polygon(coords, {
        color: APP_CONFIG.boundaryColor,
        weight: APP_CONFIG.boundaryWeight,
        fillColor: APP_CONFIG.boundaryColor,
        fillOpacity: APP_CONFIG.boundaryOpacity,
      }).addTo(map);

      boundaryLayer.bindPopup(`
        <div class="popup-title">Chân Mây - Lăng Cô</div>
        <div class="popup-description">Vùng du lịch ven biển</div>
      `);
      
      hideLoading();
    }

    // Hàm tạo ranh giới từ dữ liệu OSM
    function createBoundaryFromOSMData(data) {
      try {
        const relation = data.elements.find((el) => el.type === "relation");
        if (!relation) {
          throw new Error("Không tìm thấy relation trong dữ liệu OSM");
        }

        const nodes = new Map();
        data.elements
          .filter((el) => el.type === "node")
          .forEach((node) => nodes.set(node.id, [node.lat, node.lon]));

        const memberWays = relation.members
          .filter((m) => m.type === "way")
          .map((m) =>
            data.elements.find((el) => el.type === "way" && el.id === m.ref)
          )
          .filter(Boolean);

        const wayChains = memberWays.map((way) =>
          way.nodes.map((id) => nodes.get(id)).filter(Boolean)
        );

        const polygons = [];
        while (wayChains.length > 0) {
          let chain = wayChains.shift();
          let extended = true;

          while (extended) {
            extended = false;
            for (let i = 0; i < wayChains.length; i++) {
              const next = wayChains[i];
              const start1 = chain[0], end1 = chain[chain.length - 1];
              const start2 = next[0], end2 = next[next.length - 1];

              const same = (a, b) =>
                Math.abs(a[0] - b[0]) < 0.0001 &&
                Math.abs(a[1] - b[1]) < 0.0001;

              if (same(end1, start2)) {
                chain = [...chain, ...next.slice(1)];
                wayChains.splice(i, 1);
                extended = true;
                break;
              } else if (same(end1, end2)) {
                chain = [...chain, ...next.slice(0, -1).reverse()];
                wayChains.splice(i, 1);
                extended = true;
                break;
              } else if (same(start1, end2)) {
                chain = [...next.slice(0, -1), ...chain];
                wayChains.splice(i, 1);
                extended = true;
                break;
              } else if (same(start1, start2)) {
                chain = [...next.slice(1).reverse(), ...chain];
                wayChains.splice(i, 1);
                extended = true;
                break;
              }
            }
          }

          const first = chain[0];
          const last = chain[chain.length - 1];
          if (
            !(
              Math.abs(first[0] - last[0]) < 0.0001 &&
              Math.abs(first[1] - last[1]) < 0.0001
            )
          ) {
            chain.push(first);
          }

          polygons.push(chain);
        }

        const areas = polygons.map((poly) =>
          turf.area(turf.polygon([poly.map((p) => [p[1], p[0]])]))
        );
        const maxIndex = areas.indexOf(Math.max(...areas));
        const mainPolygon = polygons[maxIndex];

        if (!mainPolygon || mainPolygon.length < 3) {
          throw new Error("Không thể tái tạo ranh giới chính xác");
        }

        boundaryLayer = L.polygon(mainPolygon, {
          color: APP_CONFIG.boundaryColor,
          weight: APP_CONFIG.boundaryWeight,
          fillColor: APP_CONFIG.boundaryColor,
          fillOpacity: APP_CONFIG.boundaryOpacity,
        }).addTo(map);

        boundaryLayer.bindPopup(`
          <div class="popup-container-custom">
              <div class="popup-header">
                  <button class="close-btn" onclick="this.closest('.leaflet-popup').querySelector('.leaflet-popup-close-btn').click()">×</button>
                  <div class="location-title">
                      <span class="icon">📍</span>
                      <span>Xã Chân Mây - Lăng Cô</span>
                  </div>
                  <div class="city-badge">🏙️ TP. Huế</div>
              </div>

              <div class="tags-section">
                  <div class="tags-title">
                      <span class="icon">🔄</span>
                      <span>Sắp nhập từ</span>
                  </div>
                  <div class="tags-container">
                      <span class="tag highlight">Thị trấn Lăng Cô</span>
                      <span class="tag">Xã Lộc Tiến</span>
                      <span class="tag">Xã Lộc Vĩnh</span>
                      <span class="tag">Xã Lộc Thủy</span>
                  </div>
              </div>

              <div class="info-grid">
                  <div class="info-card green">
                      <div class="info-label">
                          <span class="icon">📐</span>
                          <span>Diện tích</span>
                      </div>
                      <div class="info-value">261.38 km²</div>
                  </div>

                  <div class="info-card purple">
                      <div class="info-label">
                          <span class="icon">📊</span>
                          <span>Mật độ</span>
                      </div>
                      <div class="info-value">195/km²</div>
                  </div>

                  <div class="info-card pink">
                      <div class="info-label">
                          <span class="icon">👥</span>
                          <span>Dân số</span>
                      </div>
                      <div class="info-value">50,831</div>
                  </div>

                  <div class="info-card orange">
                      <div class="info-label">
                          <span class="icon">🏷️</span>
                          <span>Mã xã</span>
                      </div>
                      <div class="info-value">20137</div>
                  </div>
              </div>

              <div class="admin-section">
                  <div class="admin-title">
                      <span class="icon">🏛️</span>
                      <span>Trung tâm hành chính</span>
                  </div>
                  <div class="admin-value">Thôn Bình An, xã Chân Mây - Lăng Cô</div>
              </div>

              <div class="footer-section">
                  <div class="footer-location">Chân Mây - Lăng Cô Commune, Huế, Vietnam</div>
                  <div class="osm-id">OSM ID: 19325212</div>
              </div>
          </div>
        `, {
          maxWidth: 380,
          className: 'custom-popup'
        });

        map.fitBounds(boundaryLayer.getBounds());
        hideLoading();
      } catch (error) {
        handleError(error, "createBoundaryFromOSMData");
        createEstimatedBoundary();
      }
    }

    // ========== QUẢN LÝ MARKER VÀ BỘ LỌC ==========
    
    // Hàm thêm marker vào bản đồ
    function addMarkersToMap() {
      MARKERS_DATA.forEach(function(marker, index) {
        const simpleIcon = createSimpleIcon(marker.color);
        
        const markerObj = L.marker(marker.coords, { icon: simpleIcon })
          .addTo(map)
          .on('click', function() {
            showLocationDetails(index);
            map.setView(marker.coords, 14);
            highlightLocationItem(index);
          });
          
        markerObjects.push(markerObj);
      });
    }

    // Hàm lọc và hiển thị marker
    function filterAndDisplayMarkers() {
      const filteredMarkers = MARKERS_DATA.filter(marker => {
        // Lọc theo loại hình
        if (activeFilters.type && marker.filters.type !== activeFilters.type) {
          return false;
        }
        
        // Lọc theo phù hợp
        if (activeFilters.suitability.length > 0) {
          const hasMatchingSuitability = activeFilters.suitability.some(suit => 
            marker.filters.suitability.includes(suit)
          );
          if (!hasMatchingSuitability) return false;
        }
        
        // Lọc theo ngân sách
        if (marker.filters.budget > activeFilters.budget) {
          return false;
        }
        
        // Lọc theo độ tuổi
        if (activeFilters.age !== "all" && !marker.filters.age.includes(activeFilters.age)) {
          return false;
        }
        
        // Lọc theo thời gian
        if (marker.filters.time > activeFilters.time) {
          return false;
        }
        
        return true;
      });
      
      // Ẩn tất cả marker
      markerObjects.forEach(marker => {
        map.removeLayer(marker);
      });
      
      // Hiển thị marker đã lọc
      filteredMarkers.forEach(markerData => {
        const index = MARKERS_DATA.findIndex(m => m.id === markerData.id);
        if (index !== -1) {
          map.addLayer(markerObjects[index]);
        }
      });
      
      // Cập nhật danh sách địa điểm
      updateLocationList(filteredMarkers);
    }

    // Hàm cập nhật danh sách địa điểm
    function updateLocationList(filteredMarkers) {
      const locationList = document.getElementById('location-list');
      locationList.innerHTML = '';
      
      filteredMarkers.forEach(function(markerData) {
        const index = MARKERS_DATA.findIndex(m => m.id === markerData.id);
        if (index === -1) return;
        
        const listItem = document.createElement('li');
        listItem.className = 'location-item';
        listItem.setAttribute('data-id', markerData.id);
        
        // Tạo tags hiển thị
        const tagsHTML = createTagsHTML(markerData.filters);
        
        listItem.innerHTML = `
          <div class="location-icon" style="background-color: ${markerData.color}">
            <i class="fas fa-map-marker-alt"></i>
          </div>
          <div class="location-content">
            <div class="location-title">${markerData.title}</div>
            <div class="location-desc">${markerData.description.substring(0, 80)}...</div>
            <div class="location-tags">
              ${tagsHTML}
            </div>
          </div>
        `;
        
        listItem.addEventListener('click', function() {
          // Di chuyển bản đồ đến vị trí marker
          map.setView(markerData.coords, 14);
          // Hiển thị thông tin chi tiết
          showLocationDetails(index);
          // Đánh dấu item được chọn
          highlightLocationItem(index);
          
          // Tự động đóng sidebar trên di động
          if (window.innerWidth <= 768) {
            sidebar.classList.add('collapsed');
            sidebarToggle.innerHTML = '<i class="fas fa-bars"></i>';
          }
        });
        
        locationList.appendChild(listItem);
      });
      
      // Hiển thị thông báo nếu không có kết quả
      if (filteredMarkers.length === 0) {
        const noResults = document.createElement('li');
        noResults.innerHTML = `
          <div style="text-align: center; padding: 20px; color: #718096;">
            <i class="fas fa-search" style="font-size: 24px; margin-bottom: 10px;"></i>
            <div>Không tìm thấy địa điểm phù hợp</div>
          </div>
        `;
        locationList.appendChild(noResults);
      }
    }

    // Hàm tạo HTML cho tags
    function createTagsHTML(filters) {
      let tagsHTML = '';
      
      // Tag loại hình
      const typeLabels = {
        'baibien': '🏖️ Bãi biển',
        'nghiduong': '🏨 Resort',
        'nhahang': '🍽️ Ẩm thực',
        'ditich': '🏛️ Di tích',
        'giaitri': '🎯 Giải trí',
        'muasam': '🛍️ Mua sắm'
      };
      
      if (typeLabels[filters.type]) {
        tagsHTML += `<div class="location-tag">${typeLabels[filters.type]}</div>`;
      }
      
      // Tag ngân sách
      const budgetLabels = ['💰 Miễn phí', '💰 Tiết kiệm', '💰 Trung bình', '💰 Cao cấp', '💰 Luxury'];
      tagsHTML += `<div class="location-tag">${budgetLabels[filters.budget]}</div>`;
      
      // Tag thời gian
      const timeLabels = ['⏱️ Dưới 1h', '⏱️ 1-2h', '⏱️ 2-4h', '⏱️ Nửa ngày', '⏱️ Cả ngày'];
      tagsHTML += `<div class="location-tag">${timeLabels[filters.time]}</div>`;
      
      return tagsHTML;
    }

    // Hàm tạo danh sách địa điểm trong sidebar
    function createLocationList() {
      updateLocationList(MARKERS_DATA);
    }

    // Hàm đánh dấu item trong danh sách
    function highlightLocationItem(index) {
      const items = document.querySelectorAll('.location-item');
      items.forEach(function(item, i) {
        if (i === index) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });
      currentMarkerIndex = index;
    }

    // Hàm hiển thị chi tiết địa điểm
    function showLocationDetails(index) {
      const marker = MARKERS_DATA[index];
      const infoPanel = document.getElementById('info-panel');
      
      // Cập nhật thông tin
      document.getElementById('info-image').src = marker.image;
      document.getElementById('info-title').textContent = marker.title;
      document.getElementById('info-description').textContent = marker.description;
      document.getElementById('info-address').textContent = marker.address;
      document.getElementById('info-phone').textContent = marker.phone || "Không có thông tin";
      document.getElementById('info-hours').textContent = marker.hours;
      document.getElementById('info-price').textContent = marker.price;
      
      // Cập nhật tags trong info panel
      const infoTags = document.getElementById('info-tags');
      infoTags.innerHTML = createTagsHTML(marker.filters);
      
      // Cập nhật sự kiện cho các nút
      document.getElementById('info-website').onclick = function() {
        if (marker.link && marker.link !== "https://example.com") {
          window.open(marker.link, '_blank');
        } else {
          alert("Không có thông tin website cho địa điểm này");
        }
      };
      
      document.getElementById('info-direction').onclick = function() {
        const url = `https://www.google.com/maps/dir/?api=1&destination=${marker.coords[0]},${marker.coords[1]}`;
        window.open(url, '_blank');
      };
      
      // Hiển thị panel
      infoPanel.classList.add('active');
    }

    // ========== XỬ LÝ SỰ KIỆN BỘ LỌC ==========
    
    // Hàm thiết lập bộ lọc
    function setupFilters() {
      // Bộ lọc loại hình
      const typeFilterTags = document.querySelectorAll('.filter-tag[data-type]');
      typeFilterTags.forEach(tag => {
        tag.addEventListener('click', function() {
          const type = this.getAttribute('data-type');
          
          // Toggle active state
          if (this.classList.contains('active')) {
            this.classList.remove('active');
            activeFilters.type = null;
          } else {
            // Remove active from all type filters
            typeFilterTags.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            activeFilters.type = type;
          }
          
          filterAndDisplayMarkers();
        });
      });
      
      // Bộ lọc phù hợp
      const suitabilityTags = document.querySelectorAll('.filter-tag[data-criteria]');
      suitabilityTags.forEach(tag => {
        tag.addEventListener('click', function() {
          const criteria = this.getAttribute('data-criteria');
          
          // Toggle active state
          if (this.classList.contains('active')) {
            this.classList.remove('active');
            activeFilters.suitability = activeFilters.suitability.filter(c => c !== criteria);
          } else {
            this.classList.add('active');
            activeFilters.suitability.push(criteria);
          }
          
          filterAndDisplayMarkers();
        });
      });
      
      // Bộ lọc ngân sách
      const budgetSlider = document.getElementById('budget-slider');
      budgetSlider.addEventListener('input', function() {
        activeFilters.budget = parseInt(this.value);
        filterAndDisplayMarkers();
      });
      
      // Bộ lọc độ tuổi
      const ageButtons = document.querySelectorAll('.age-btn');
      ageButtons.forEach(button => {
        button.addEventListener('click', function() {
          const age = this.getAttribute('data-age');
          
          // Remove active from all age buttons
          ageButtons.forEach(btn => btn.classList.remove('active'));
          this.classList.add('active');
          
          activeFilters.age = age;
          filterAndDisplayMarkers();
        });
      });
      
      // Bộ lọc thời gian
      const timeSlider = document.getElementById('time-slider');
      timeSlider.addEventListener('input', function() {
        activeFilters.time = parseInt(this.value);
        filterAndDisplayMarkers();
      });
      
      // Nút xóa tất cả bộ lọc
      document.getElementById('clear-filters').addEventListener('click', function() {
        // Reset all filters
        activeFilters = {
          type: null,
          suitability: [],
          budget: 4,
          age: "all",
          time: 4
        };
        
        // Reset UI
        typeFilterTags.forEach(tag => tag.classList.remove('active'));
        suitabilityTags.forEach(tag => tag.classList.remove('active'));
        budgetSlider.value = 4;
        timeSlider.value = 4;
        ageButtons.forEach(btn => {
          if (btn.getAttribute('data-age') === 'all') {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });
        
        filterAndDisplayMarkers();
      });
    }

    // Hàm thiết lập toggle cho bộ lọc
    function setupFilterToggles() {
      const typeFilterHeader = document.getElementById('type-filter-header');
      const typeFilterContent = document.getElementById('type-filter-content');
      const typeFilterToggle = document.getElementById('type-filter-toggle');
      
      const criteriaFilterHeader = document.getElementById('criteria-filter-header');
      const criteriaFilterContent = document.getElementById('criteria-filter-content');
      const criteriaFilterToggle = document.getElementById('criteria-filter-toggle');
      
      // Toggle bộ lọc loại hình
      typeFilterHeader.addEventListener('click', function() {
        typeFilterContent.classList.toggle('collapsed');
        typeFilterToggle.classList.toggle('rotated');
      });
      
      // Toggle bộ lọc tiêu chí
      criteriaFilterHeader.addEventListener('click', function() {
        criteriaFilterContent.classList.toggle('collapsed');
        criteriaFilterToggle.classList.toggle('rotated');
      });
    }

    // ========== XỬ LÝ SỰ KIỆN KHÁC ==========
    
    // Xử lý sự kiện tìm kiếm
    function setupSearch() {
      const searchInput = document.getElementById('search-input');
      searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const items = document.querySelectorAll('.location-item');
        
        items.forEach(function(item) {
          const title = item.querySelector('.location-title').textContent.toLowerCase();
          const desc = item.querySelector('.location-desc').textContent.toLowerCase();
          
          if (title.includes(searchTerm) || desc.includes(searchTerm)) {
            item.style.display = 'flex';
          } else {
            item.style.display = 'none';
          }
        });
      });
    }

    // Xử lý sự kiện sidebar toggle
    function setupSidebar() {
      const sidebar = document.getElementById('sidebar');
      const sidebarToggle = document.getElementById('sidebar-toggle');
      
      sidebarToggle.addEventListener('click', function() {
        sidebar.classList.toggle('collapsed');
        if (sidebar.classList.contains('collapsed')) {
          sidebarToggle.innerHTML = '<i class="fas fa-bars"></i>';
        } else {
          sidebarToggle.innerHTML = '<i class="fas fa-chevron-left"></i>';
        }
      });
    }

    // Xử lý sự kiện đóng info panel
    function setupInfoPanel() {
      document.getElementById('info-close').addEventListener('click', function() {
        document.getElementById('info-panel').classList.remove('active');
      });
    }

    // Xử lý sự kiện các nút điều khiển bản đồ
    function setupMapControls() {
      // Nút locate me
      document.getElementById('locate-me').addEventListener('click', function() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            const latlng = L.latLng(position.coords.latitude, position.coords.longitude);
            map.setView(latlng, 14);
            L.marker(latlng)
              .addTo(map)
              .bindPopup("Vị trí của bạn")
              .openPopup();
          }, function(error) {
            alert("Không thể lấy vị trí của bạn: " + error.message);
          });
        } else {
          alert("Trình duyệt không hỗ trợ định vị");
        }
      });

      // Nút toggle boundary
      document.getElementById('toggle-boundary').addEventListener('click', function() {
        if (boundaryLayer) {
          if (boundaryVisible) {
            map.removeLayer(boundaryLayer);
          } else {
            map.addLayer(boundaryLayer);
          }
          boundaryVisible = !boundaryVisible;
        }
      });

      // Nút toggle satellite
      document.getElementById('toggle-satellite').addEventListener('click', function() {
        if (isSatellite) {
          map.removeLayer(satelliteLayer);
          map.addLayer(osmLayer);
        } else {
          map.removeLayer(osmLayer);
          map.addLayer(satelliteLayer);
        }
        isSatellite = !isSatellite;
      });

      // Nút fullscreen
      document.getElementById('fullscreen').addEventListener('click', function() {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen();
          this.innerHTML = '<i class="fas fa-compress"></i>';
        } else {
          if (document.exitFullscreen) {
            document.exitFullscreen();
            this.innerHTML = '<i class="fas fa-expand"></i>';
          }
        }
      });
    }

    // Thiết lập UX cho thiết bị di động
    function setupMobileUX() {
      const isMobile = window.innerWidth <= 768;
      
      if (isMobile) {
        // Đóng sidebar khi chọn địa điểm
        const locationItems = document.querySelectorAll('.location-item');
        locationItems.forEach(item => {
          item.addEventListener('click', () => {
            sidebar.classList.add('collapsed');
            sidebarToggle.innerHTML = '<i class="fas fa-bars"></i>';
          });
        });
        
        // Đóng info panel khi nhấn ra ngoài (trên di động)
        document.addEventListener('click', (e) => {
          const infoPanel = document.getElementById('info-panel');
          if (infoPanel.classList.contains('active') && 
              !e.target.closest('.info-panel') && 
              !e.target.closest('.location-item') &&
              !e.target.closest('.simple-marker')) {
            infoPanel.classList.remove('active');
          }
        });
      }
    }

    // ========== KHỞI TẠO ỨNG DỤNG ==========
    
    // Hàm khởi tạo ứng dụng
    function initApp() {
      // Gọi dữ liệu OSM để tạo ranh giới
      fetch(`https://overpass-api.de/api/interpreter?data=[out:json];relation(${APP_CONFIG.osmRelationId});(._;>;);out;`)
        .then((res) => res.json())
        .then(createBoundaryFromOSMData)
        .catch((err) => {
          handleError(err, "fetch OSM data");
          createEstimatedBoundary();
        });

      // Thêm marker vào bản đồ
      addMarkersToMap();
      
      // Tạo danh sách địa điểm
      createLocationList();
      
      // Thiết lập các sự kiện
      setupFilters();
      setupFilterToggles();
      setupSearch();
      setupSidebar();
      setupInfoPanel();
      setupMapControls();
      setupMobileUX();
      
      // Ẩn loading sau khi tải xong
      setTimeout(hideLoading, 1000);
    }

    // Khởi chạy ứng dụng khi DOM đã sẵn sàng
    document.addEventListener('DOMContentLoaded', initApp);
    
    // Thiết lập lại UX khi thay đổi kích thước cửa sổ
    window.addEventListener('resize', setupMobileUX);
  </script>
</body>
</html>