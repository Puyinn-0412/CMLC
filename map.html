<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>B·∫£n ƒë·ªì Ch√¢n M√¢y - LƒÉng C√¥</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Turf.js ƒë·ªÉ t√≠nh di·ªán t√≠ch polygon -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* Reset v√† base styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow: hidden;
    }

    #map {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }

    /* Sidebar styles */
    .sidebar {
      position: absolute;
      top: 0;
      left: 0;
      width: 420px;
      height: 100%;
      background: white;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      z-index: 10;
      transition: transform 0.3s ease;
      overflow-y: auto;
    }

    .sidebar.collapsed {
      transform: translateX(-100%);
    }

    .sidebar-toggle {
      position: absolute;
      top: 15px;
      right: -45px;
      width: 40px;
      height: 40px;
      background: white;
      border: none;
      border-radius: 50%;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 11;
    }

    .sidebar-content {
      padding: 20px;
    }

    .sidebar-header {
      margin-bottom: 20px;
    }

    .sidebar-header h1 {
      font-size: 24px;
      color: #2d3748;
      margin-bottom: 5px;
    }

    .sidebar-header p {
      color: #718096;
      font-size: 14px;
    }

    .search-box {
      position: relative;
      margin-bottom: 20px;
    }

    .search-box input {
      width: 100%;
      padding: 12px 15px 12px 40px;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.3s;
    }

    .search-box input:focus {
      outline: none;
      border-color: #4299e1;
      box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
    }

    .search-box i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #a0aec0;
    }

    /* Filter sections */
    .filter-section {
      margin-bottom: 20px;
      background: #f8fafc;
      border-radius: 12px;
      padding: 15px;
    }

    .filter-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      cursor: pointer;
    }

    .filter-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      color: #2d3748;
      font-size: 15px;
    }

    .filter-toggle {
      background: none;
      border: none;
      color: #718096;
      cursor: pointer;
      transition: transform 0.3s;
    }

    .filter-toggle.rotated {
      transform: rotate(180deg);
    }

    .filter-content {
      display: block;
    }

    .filter-content.collapsed {
      display: none;
    }

    .filter-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .filter-tag {
      background: white;
      border: 1px solid #e2e8f0;
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 13px;
      color: #4a5568;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .filter-tag:hover {
      background: #edf2f7;
    }

    .filter-tag.active {
      background: #4299e1;
      color: white;
      border-color: #4299e1;
    }

    .budget-slider {
      width: 100%;
      margin: 10px 0;
    }

    .budget-labels {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #718096;
      margin-top: 5px;
    }

    .time-slider {
      width: 100%;
      margin: 10px 0;
    }

    .time-labels {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #718096;
      margin-top: 5px;
    }

    .age-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .age-btn {
      padding: 8px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 13px;
      text-align: center;
    }

    .age-btn:hover {
      background: #edf2f7;
    }

    .age-btn.active {
      background: #4299e1;
      color: white;
      border-color: #4299e1;
    }

    .clear-filters {
      width: 100%;
      padding: 12px;
      background: #e53e3e;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
      margin-top: 10px;
    }

    .clear-filters:hover {
      background: #c53030;
    }

    .location-list {
      list-style: none;
    }

    .location-item {
      display: flex;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.3s;
      border: 1px solid transparent;
    }

    .location-item:hover {
      background: #f7fafc;
      border-color: #e2e8f0;
    }

    .location-item.active {
      background: #ebf8ff;
      border-color: #4299e1;
    }

    .location-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      margin-right: 15px;
      flex-shrink: 0;
    }

    .location-content {
      flex: 1;
    }

    .location-content .location-title {
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 5px;
    }

    .location-content .location-desc {
      font-size: 13px;
      color: #718096;
      line-height: 1.4;
    }

    .location-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 8px;
    }

    .location-tag {
      background: #edf2f7;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      color: #4a5568;
    }

    /* Info Panel styles */
    .info-panel {
      position: absolute;
      top: 0;
      right: -400px;
      width: 400px;
      height: 100%;
      background: white;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      z-index: 10;
      transition: right 0.3s ease;
      overflow-y: auto;
    }

    .info-panel.active {
      right: 0;
    }

    .info-header {
      position: relative;
      height: 200px;
      overflow: hidden;
    }

    .info-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .info-close {
      position: absolute;
      top: 15px;
      right: 15px;
      width: 40px;
      height: 40px;
      background: rgba(0, 0, 0, 0.5);
      border: none;
      border-radius: 50%;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .info-content {
      padding: 20px;
    }

    .info-title {
      font-size: 22px;
      color: #2d3748;
      margin-bottom: 10px;
    }

    .info-description {
      color: #718096;
      line-height: 1.6;
      margin-bottom: 20px;
    }

    .info-details {
      margin-bottom: 20px;
    }

    .info-detail {
      display: flex;
      margin-bottom: 10px;
      align-items: flex-start;
    }

    .info-detail i {
      width: 20px;
      margin-right: 10px;
      color: #4299e1;
      margin-top: 2px;
    }

    .info-detail strong {
      color: #4a5568;
      margin-right: 5px;
    }

    .info-detail span {
      color: #718096;
    }

    .info-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 15px 0;
    }

    .info-tag {
      background: #ebf8ff;
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 12px;
      color: #2b6cb0;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .info-actions {
      display: flex;
      gap: 10px;
    }

    .info-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.3s;
    }

    .info-btn.primary {
      background: #4299e1;
      color: white;
    }

    .info-btn.primary:hover {
      background: #3182ce;
    }

    .info-btn.secondary {
      background: #e2e8f0;
      color: #4a5568;
    }

    .info-btn.secondary:hover {
      background: #cbd5e0;
    }

    /* Map Controls */
    .map-controls {
      position: absolute;
      bottom: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 5;
    }

    .map-control {
      width: 50px;
      height: 50px;
      background: white;
      border: none;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #4a5568;
      transition: all 0.3s;
    }

    .map-control:hover {
      background: #f7fafc;
      color: #4299e1;
    }

    /* Legend */
    .legend {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      z-index: 5;
      max-width: 250px;
    }

    .legend h4 {
      margin-bottom: 10px;
      color: #2d3748;
      font-size: 16px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }

    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      margin-right: 10px;
      border: 2px solid;
    }

    .boundary-color {
      background: rgba(52, 152, 219, 0.2);
      border-color: #3498db;
    }

    /* Loading indicator */
    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px 30px;
      border-radius: 10px;
      box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
      z-index: 100;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .loading-spinner {
      width: 30px;
      height: 30px;
      border: 3px solid #e2e8f0;
      border-top: 3px solid #4299e1;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsive styles */
    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        max-width: 320px;
      }
      
      .info-panel {
        width: 100%;
        max-width: 320px;
        right: -320px;
      }
      
      .legend {
        max-width: 200px;
        bottom: 80px;
      }
      
      .map-controls {
        bottom: 20px;
        right: 10px;
      }
    }

    /* Override Leaflet popup styles */
    .leaflet-popup-content-wrapper {
      padding: 0 !important;
      border-radius: 20px !important;
      overflow: hidden !important;
      background: white !important;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3) !important;
    }

    .leaflet-popup-content {
      margin: 0 !important;
      width: 360px !important;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
    }

    .leaflet-popup-close-btn {
      display: none !important;
    }

    .leaflet-popup-tip {
      display: none !important;
    }

    .popup-container-custom {
      width: 100%;
      background: white;
    }

    .popup-header {
      background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
      padding: 18px 20px;
      position: relative;
      color: white;
    }

    .close-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      font-size: 20px;
      color: white;
      cursor: pointer;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      line-height: 1;
    }

    .location-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 17px;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .icon {
      font-size: 18px;
    }

    .city-badge {
      display: inline-block;
      background: rgba(14, 165, 233, 0.95);
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      margin-top: 8px;
    }

    .tags-section {
      margin: 16px 18px;
      padding: 14px;
      background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
      border-radius: 12px;
    }

    .tags-title {
      display: flex;
      align-items: center;
      gap: 6px;
      color: #0369a1;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .tags-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .tag {
      background: white;
      border: 2px solid transparent;
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 12px;
      color: #4a5568;
      font-weight: 500;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .tag.highlight {
      background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
      color: white;
      font-weight: 600;
    }

    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      padding: 0 18px 16px 18px;
    }

    .info-card {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      padding: 14px;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
      position: relative;
      overflow: hidden;
    }

    .info-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--accent-color);
    }

    .info-card.green { --accent-color: linear-gradient(90deg, #0891b2, #06b6d4); }
    .info-card.purple { --accent-color: linear-gradient(90deg, #3b82f6, #60a5fa); }
    .info-card.pink { --accent-color: linear-gradient(90deg, #0ea5e9, #38bdf8); }
    .info-card.orange { --accent-color: linear-gradient(90deg, #14b8a6, #2dd4bf); }

    .info-label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 6px;
      text-transform: uppercase;
    }

    .info-value {
      font-size: 16px;
      font-weight: 700;
    }

    .info-card.green .info-value { color: #0891b2; }
    .info-card.purple .info-value { color: #3b82f6; }
    .info-card.pink .info-value { color: #0ea5e9; }
    .info-card.orange .info-value { color: #14b8a6; }

    .admin-section {
      padding: 16px 18px;
      background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
      margin: 0 18px 16px 18px;
      border-radius: 12px;
    }

    .admin-title {
      display: flex;
      align-items: center;
      gap: 6px;
      color: #0369a1;
      font-size: 12px;
      font-weight: 700;
      margin-bottom: 6px;
      text-transform: uppercase;
    }

    .admin-value {
      font-size: 13px;
      color: #334155;
      font-weight: 500;
      line-height: 1.6;
    }

    .footer-section {
      padding: 14px 18px 16px 18px;
      text-align: center;
      color: #64748b;
      font-size: 12px;
      line-height: 1.6;
      background: #f8fafc;
    }

    .footer-location {
      font-weight: 500;
      color: #475569;
      margin-bottom: 4px;
    }

    .osm-id {
      color: #94a3b8;
      font-size: 12px;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  
  <!-- Loading indicator -->
  <div class="loading" id="loading">
    <div class="loading-spinner"></div>
    <span>ƒêang t·∫£i b·∫£n ƒë·ªì...</span>
  </div>
  
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <button class="sidebar-toggle" id="sidebar-toggle">
      <i class="fas fa-bars"></i>
    </button>
    
    <div class="sidebar-content">
      <div class="sidebar-header">
        <h1>üåä Ch√¢n M√¢y - LƒÉng C√¥</h1>
        <p>Kh√°m ph√° c√°c ƒëi·ªÉm du l·ªãch tuy·ªát v·ªùi</p>
      </div>
      
      <div class="search-box">
        <input type="text" id="search-input" placeholder="T√¨m ki·∫øm ƒë·ªãa ƒëi·ªÉm...">
        <i class="fas fa-search"></i>
      </div>
      
      <!-- B·ªô l·ªçc lo·∫°i h√¨nh -->
      <div class="filter-section">
        <div class="filter-header" id="type-filter-header">
          <div class="filter-title">
            <i class="fas fa-filter"></i>
            <span>Lo·∫°i h√¨nh</span>
          </div>
          <button class="filter-toggle" id="type-filter-toggle">
            <i class="fas fa-chevron-down"></i>
          </button>
        </div>
        <div class="filter-content" id="type-filter-content">
          <div class="filter-tags">
            <div class="filter-tag" data-type="baibien">
              <i class="fas fa-umbrella-beach"></i>
              <span>B√£i bi·ªÉn</span>
            </div>
            <div class="filter-tag" data-type="nghiduong">
              <i class="fas fa-hotel"></i>
              <span>Resort & Kh√°ch s·∫°n</span>
            </div>
            <div class="filter-tag" data-type="nhahang">
              <i class="fas fa-utensils"></i>
              <span>Nh√† h√†ng & ·∫®m th·ª±c</span>
            </div>
            <div class="filter-tag" data-type="ditich">
              <i class="fas fa-landmark"></i>
              <span>Di t√≠ch l·ªãch s·ª≠</span>
            </div>
            <div class="filter-tag" data-type="giaitri">
              <i class="fas fa-gamepad"></i>
              <span>Gi·∫£i tr√≠</span>
            </div>
            <div class="filter-tag" data-type="muasam">
              <i class="fas fa-shopping-bag"></i>
              <span>Mua s·∫Øm</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- B·ªô l·ªçc ti√™u ch√≠ -->
      <div class="filter-section">
        <div class="filter-header" id="criteria-filter-header">
          <div class="filter-title">
            <i class="fas fa-star"></i>
            <span>Ti√™u ch√≠</span>
          </div>
          <button class="filter-toggle" id="criteria-filter-toggle">
            <i class="fas fa-chevron-down"></i>
          </button>
        </div>
        <div class="filter-content" id="criteria-filter-content">
          <!-- Ph√π h·ª£p gia ƒë√¨nh -->
          <div style="margin-bottom: 15px;">
            <div style="font-weight: 600; margin-bottom: 8px; color: #2d3748;">Ph√π h·ª£p</div>
            <div class="filter-tags">
              <div class="filter-tag" data-criteria="family">
                <i class="fas fa-users"></i>
                <span>Gia ƒë√¨nh</span>
              </div>
              <div class="filter-tag" data-criteria="couple">
                <i class="fas fa-heart"></i>
                <span>L√£ng m·∫°n</span>
              </div>
              <div class="filter-tag" data-criteria="solo">
                <i class="fas fa-user"></i>
                <span>ƒêi m·ªôt m√¨nh</span>
              </div>
            </div>
          </div>
          
          <!-- Ng√¢n s√°ch -->
          <div style="margin-bottom: 15px;">
            <div style="font-weight: 600; margin-bottom: 8px; color: #2d3748;">Ng√¢n s√°ch</div>
            <input type="range" min="0" max="4" value="4" class="budget-slider" id="budget-slider">
            <div class="budget-labels">
              <span>Mi·ªÖn ph√≠</span>
              <span>Ti·∫øt ki·ªám</span>
              <span>Trung b√¨nh</span>
              <span>Cao c·∫•p</span>
              <span>Luxury</span>
            </div>
          </div>
          
          <!-- ƒê·ªô tu·ªïi -->
          <div style="margin-bottom: 15px;">
            <div style="font-weight: 600; margin-bottom: 8px; color: #2d3748;">ƒê·ªô tu·ªïi</div>
            <div class="age-buttons">
              <button class="age-btn" data-age="all">T·∫•t c·∫£</button>
              <button class="age-btn" data-age="child">Tr·∫ª em</button>
              <button class="age-btn" data-age="teen">Thanh thi·∫øu ni√™n</button>
              <button class="age-btn" data-age="adult">Ng∆∞·ªùi l·ªõn</button>
              <button class="age-btn" data-age="senior">Ng∆∞·ªùi cao tu·ªïi</button>
            </div>
          </div>
          
          <!-- Th·ªùi gian tham quan -->
          <div>
            <div style="font-weight: 600; margin-bottom: 8px; color: #2d3748;">Th·ªùi gian tham quan</div>
            <input type="range" min="0" max="4" value="4" class="time-slider" id="time-slider">
            <div class="time-labels">
              <span>D∆∞·ªõi 1h</span>
              <span>1-2h</span>
              <span>2-4h</span>
              <span>N·ª≠a ng√†y</span>
              <span>C·∫£ ng√†y</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- N√∫t x√≥a b·ªô l·ªçc -->
      <button class="clear-filters" id="clear-filters">
        <i class="fas fa-times"></i>
        X√≥a t·∫•t c·∫£ b·ªô l·ªçc
      </button>
      
      <h3 style="margin: 20px 0 15px; color: #2d3748;">ƒê·ªãa ƒëi·ªÉm n·ªïi b·∫≠t</h3>
      <ul class="location-list" id="location-list">
        <!-- Danh s√°ch ƒë·ªãa ƒëi·ªÉm s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
      </ul>
    </div>
  </div>
  
  <!-- Info Panel -->
  <div class="info-panel" id="info-panel">
    <div class="info-header">
      <img id="info-image" src="" alt="" class="info-image">
      <button class="info-close" id="info-close">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="info-content">
      <h2 class="info-title" id="info-title"></h2>
      <p class="info-description" id="info-description"></p>
      
      <!-- Tags trong info panel -->
      <div class="info-tags" id="info-tags">
        <!-- Tags s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
      </div>
      
      <div class="info-details">
        <div class="info-detail">
          <i class="fas fa-map-marker-alt"></i>
          <strong>ƒê·ªãa ch·ªâ:</strong> <span id="info-address"></span>
        </div>
        <div class="info-detail">
          <i class="fas fa-phone"></i>
          <strong>ƒêi·ªán tho·∫°i:</strong> <span id="info-phone"></span>
        </div>
        <div class="info-detail">
          <i class="fas fa-clock"></i>
          <strong>Gi·ªù m·ªü c·ª≠a:</strong> <span id="info-hours"></span>
        </div>
        <div class="info-detail">
          <i class="fas fa-tag"></i>
          <strong>Gi√° v√©:</strong> <span id="info-price"></span>
        </div>
      </div>
      
      <div class="info-actions">
        <button class="info-btn secondary" id="info-direction">
          <i class="fas fa-route"></i> Ch·ªâ ƒë∆∞·ªùng
        </button>
        <button class="info-btn primary" id="info-website">
          <i class="fas fa-external-link-alt"></i> Website
        </button>
      </div>
    </div>
  </div>
  
  <!-- Map Controls -->
  <div class="map-controls">
    <button class="map-control" id="locate-me" title="V·ªã tr√≠ c·ªßa t√¥i">
      <i class="fas fa-location-arrow"></i>
    </button>
    <button class="map-control" id="toggle-boundary" title="Ranh gi·ªõi">
      <i class="fas fa-draw-polygon"></i>
    </button>
    <button class="map-control" id="toggle-satellite" title="Ch·∫ø ƒë·ªô v·ªá tinh">
      <i class="fas fa-satellite"></i>
    </button>
    <button class="map-control" id="fullscreen" title="To√†n m√†n h√¨nh">
      <i class="fas fa-expand"></i>
    </button>
  </div>
  
  <!-- Legend -->
  <div class="legend">
    <h4>Ch√∫ th√≠ch</h4>
    <div class="legend-item">
      <div class="legend-color boundary-color"></div>
      <span>Ranh gi·ªõi khu v·ª±c</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #e74c3c; border-color: #c0392b;"></div>
      <span>Di t√≠ch l·ªãch s·ª≠</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #3498db; border-color: #2980b9;"></div>
      <span>B√£i bi·ªÉn & ƒê·∫ßm n∆∞·ªõc</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #27ae60; border-color: #219a52;"></div>
      <span>Su·ªëi & Th√°c n∆∞·ªõc</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #f39c12; border-color: #e67e22;"></div>
      <span>Khu ngh·ªâ d∆∞·ª°ng</span>
    </div>
  </div>

  <script>
    // ========== C·∫§U TR√öC D·ªÆ LI·ªÜU V√Ä C·∫§U H√åNH ==========
    
    // C·∫•u h√¨nh ·ª©ng d·ª•ng
    const APP_CONFIG = {
      mapCenter: [16.27, 108.06],
      defaultZoom: 12,
      osmRelationId: 19325212,
      boundaryColor: "#3498db",
      boundaryOpacity: 0.15,
      boundaryWeight: 3
    };

    // D·ªØ li·ªáu c√°c ƒëi·ªÉm ƒë√°nh d·∫•u v·ªõi th√¥ng tin l·ªçc n√¢ng cao
    const MARKERS_DATA = [
      {
        id: 1,
        coords: [16.187768367009422, 108.13129996298079],
        title: "H·∫£i V√¢n Quan",
        description: "Di t√≠ch l·ªãch s·ª≠ n·ªïi ti·∫øng n·∫±m tr√™n ƒë·ªânh ƒë√®o H·∫£i V√¢n, t·ª´ng l√† c·ª≠a ng√µ quan tr·ªçng gi·ªØa Th·ª´a Thi√™n Hu·∫ø v√† ƒê√† N·∫µng.",
        image: "https://images.unsplash.com/photo-1507525428034-b723cf961d3e?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=600&q=80",
        category: "ditich",
        color: "#e74c3c",
        link: "https://www.google.com/maps/place/H%E1%BA%A3i+V%C3%A2n+Quan/@16.1877377,108.1287193,836m/data=!3m2!1e3!4b1!4m6!3m5!1s0x3142219e02bc568b:0xb04a3eba486386b5!8m2!3d16.1877377!4d108.1312942!16s%2Fg%2F11p5lgqrq9?hl=vi&entry=ttu&g_ep=EgoyMDI1MTAwOC4wIKXMDSoASAFQAw%3D%3D",
        address: "ƒê√®o H·∫£i V√¢n, gi√°p ranh Th√†nh ph·ªë Hu·∫ø v√† ƒê√† N·∫µng",
        phone: "0234 123 456",
        hours: "M·ªü c·ª≠a c·∫£ ng√†y",
        price: "Mi·ªÖn ph√≠",
        // Th√¥ng tin l·ªçc n√¢ng cao
        filters: {
          type: "ditich",
          suitability: ["family", "couple", "solo"],
          budget: 0, // 0: Mi·ªÖn ph√≠, 1: Ti·∫øt ki·ªám, 2: Trung b√¨nh, 3: Cao c·∫•p, 4: Luxury
          age: ["child", "teen", "adult", "senior"],
          time: 1 // 0: D∆∞·ªõi 1h, 1: 1-2h, 2: 2-4h, 3: N·ª≠a ng√†y, 4: C·∫£ ng√†y
        }
      },
      {
        id: 2,
        coords: [16.227258827040963, 108.07544107963488],
        title: "ƒê·∫ßm L·∫≠p An",
        description: "ƒê·∫ßm n∆∞·ªõc m·∫∑n r·ªông l·ªõn v·ªõi h·ªá sinh th√°i ƒëa d·∫°ng, n·ªïi ti·∫øng v·ªõi ngh·ªÅ nu√¥i h√†u v√† c·∫£nh quan thi√™n nhi√™n tuy·ªát ƒë·∫πp.",
        image: "https://upload.wikimedia.org/wikipedia/commons/c/c9/Laguna_Lap_An%2C_Provincia_de_Thua_Thien-Hue%2C_Vietnam.jpg",
        category: "damnuoc",
        color: "#3498db",
        link: "https://example.com/dam-lap-an",
        address: "X√£ Ch√¢n M√¢y LƒÉng C√¥, Th√†nh ph·ªë Hu·∫ø",
        phone: "",
        hours: "M·ªü c·∫£ ng√†y",
        price: "Mi·ªÖn ph√≠",
        filters: {
          type: "baibien",
          suitability: ["family", "couple", "solo"],
          budget: 0,
          age: ["child", "teen", "adult", "senior"],
          time: 2
        }
      },
      {
        id: 3,
        coords: [16.31724163145726, 107.97717739551304],
        title: "B√£i bi·ªÉn T√¢n C·∫£nh D∆∞∆°ng",
        description: "B√£i bi·ªÉn hoang s∆° v·ªõi c√°t tr·∫Øng v√† n∆∞·ªõc trong xanh, l√Ω t∆∞·ªüng cho nh·ªØng ai y√™u th√≠ch s·ª± y√™n tƒ©nh v√† thi√™n nhi√™n.",
        image: "https://images.unsplash.com/photo-1534430480872-3498386e7856?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=600&q=80",
        category: "baibien",
        color: "#3498db",
        link: "https://example.com/tan-canh-duong",
        address: "X√£ Ch√¢n M√¢y LƒÉng C√¥, Th√†nh ph·ªë Hu·∫ø",
        phone: "0234 123 458",
        hours: "M·ªü c·ª≠a c·∫£ ng√†y",
        price: "Mi·ªÖn ph√≠",
        filters: {
          type: "baibien",
          suitability: ["family", "couple", "solo"],
          budget: 0,
          age: ["child", "teen", "adult", "senior"],
          time: 3
        }
      },
      {
        id: 4,
        coords: [16.31296999941014, 108.00091933765658],
        title: "B√£i bi·ªÉn B√¨nh An",
        description: "B√£i bi·ªÉn ƒë·∫πp v·ªõi b√£i c√°t tr·∫Øng tr·∫£i d√†i, n∆∞·ªõc bi·ªÉn trong xanh, th√≠ch h·ª£p cho c√°c ho·∫°t ƒë·ªông t·∫Øm bi·ªÉn v√† th·ªÉ thao d∆∞·ªõi n∆∞·ªõc.",
        image: "https://images.unsplash.com/photo-1544551763-46a013bb70d5?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=600&q=80",
        category: "baibien",
        color: "#3498db",
        link: "https://example.com/binh-an",
        address: "X√£ Ch√¢n M√¢y LƒÉng C√¥, Th√†nh ph·ªë Hu·∫ø",
        phone: "0234 123 459",
        hours: "M·ªü c·ª≠a c·∫£ ng√†y",
        price: "Mi·ªÖn ph√≠",
        filters: {
          type: "baibien",
          suitability: ["family", "couple", "solo"],
          budget: 0,
          age: ["child", "teen", "adult", "senior"],
          time: 3
        }
      },
      {
        id: 5,
        coords: [16.265680775230162, 108.06610813578524],
        title: "B√£i bi·ªÉn LƒÉng C√¥",
        description: "M·ªôt trong nh·ªØng b√£i bi·ªÉn ƒë·∫πp nh·∫•t Vi·ªát Nam, ƒë∆∞·ª£c c√¥ng nh·∫≠n l√† v·ªãnh ƒë·∫πp th·∫ø gi·ªõi v·ªõi c·∫£nh quan thi√™n nhi√™n h√πng vƒ©.",
        image: "https://images.unsplash.com/photo-1597075882936-27bfa7357b3c?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=600&q=80",
        category: "baibien",
        color: "#3498db",
        link: "https://example.com/lang-co",
        address: "X√£ Ch√¢n M√¢y LƒÉng C√¥, Th√†nh ph·ªë Hu·∫ø",
        phone: "0234 123 460",
        hours: "M·ªü c·ª≠a c·∫£ ng√†y",
        price: "Mi·ªÖn ph√≠",
        filters: {
          type: "baibien",
          suitability: ["family", "couple", "solo"],
          budget: 0,
          age: ["child", "teen", "adult", "senior"],
          time: 4
        }
      },
      {
        id: 6,
        coords: [16.24402108899415, 107.98933957990741],
        title: "Su·ªëi Voi",
        description: "D√≤ng su·ªëi trong l√†nh ch·∫£y qua nh·ªØng t·∫£ng ƒë√° l·ªõn h√¨nh voi, t·∫°o n√™n khung c·∫£nh thi√™n nhi√™n ƒë·ªôc ƒë√°o v√† th∆° m·ªông.",
        image: "https://images.unsplash.com/photo-1574269909862-7e1d70bb8078?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=600&q=80",
        category: "suoi",
        color: "#27ae60",
        link: "https://example.com/suoi-voi",
        address: "X√£ Ch√¢n M√¢y LƒÉng C√¥, Th√†nh ph·ªë Hu·∫ø",
        phone: "0234 123 461",
        hours: "M·ªü c·ª≠a c·∫£ ng√†y",
        price: "Mi·ªÖn ph√≠",
        filters: {
          type: "giaitri",
          suitability: ["family", "couple", "solo"],
          budget: 0,
          age: ["child", "teen", "adult", "senior"],
          time: 2
        }
      },
      {
        id: 7,
        coords: [16.253183945484594, 107.99086924102949],
        title: "Su·ªëi B·∫ßu Gh√®",
        description: "D√≤ng su·ªëi m√°t l√†nh v·ªõi nhi·ªÅu th√°c n∆∞·ªõc nh·ªè, l√† ƒëi·ªÉm ƒë·∫øn l√Ω t∆∞·ªüng cho nh·ªØng chuy·∫øn picnic v√† kh√°m ph√° thi√™n nhi√™n.",
        image: "https://images.unsplash.com/photo-1551632811-561732d1e306?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=600&q=80",
        category: "suoi",
        color: "#27ae60",
        link: "https://example.com/suoi-bau-ghe",
        address: "X√£ Ch√¢n M√¢y LƒÉng C√¥, Th√†nh ph·ªë Hu·∫ø",
        phone: "0234 123 462",
        hours: "M·ªü c·ª≠a c·∫£ ng√†y",
        price: "Mi·ªÖn ph√≠",
        filters: {
          type: "giaitri",
          suitability: ["family", "couple", "solo"],
          budget: 0,
          age: ["child", "teen", "adult", "senior"],
          time: 2
        }
      },
      {
        id: 8,
        coords: [16.24465135364992, 107.9320540367809],
        title: "Su·ªëi Ti√™n",
        description: "D√≤ng su·ªëi v·ªõi v·∫ª ƒë·∫πp nh∆∞ ch·ªën th·∫ßn ti√™n, n∆∞·ªõc trong v·∫Øt ch·∫£y qua nh·ªØng phi·∫øn ƒë√° t·ª± nhi√™n t·∫°o th√†nh c√°c b·∫≠c thang ƒë·ªôc ƒë√°o.",
        image: "https://images.unsplash.com/photo-1439066615861-d1af74d74000?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=600&q=80",
        category: "suoi",
        color: "#27ae60",
        link: "https://example.com/suoi-tien",
        address: "X√£ Ch√¢n M√¢y LƒÉng C√¥, Th√†nh ph·ªë Hu·∫ø",
        phone: "0234 123 463",
        hours: "M·ªü c·ª≠a c·∫£ ng√†y",
        price: "Mi·ªÖn ph√≠",
        filters: {
          type: "giaitri",
          suitability: ["family", "couple", "solo"],
          budget: 0,
          age: ["child", "teen", "adult", "senior"],
          time: 2
        }
      },
      {
        id: 9,
        coords: [16.200864938077345, 108.13337584408814],
        title: "ƒê√®o H·∫£i V√¢n",
        description: "ƒê√®o H·∫£i V√¢n n·∫±m gi·ªØa Th·ª´a Thi√™n Hu·∫ø v√† ƒê√† N·∫µng, ƒë∆∞·ª£c m·ªánh danh l√† 'Thi√™n h·∫° ƒë·ªá nh·∫•t h√πng quan' v·ªõi c·∫£nh quan thi√™n nhi√™n h√πng vƒ©.",
        image: "https://images.unsplash.com/photo-1597075882936-27bfa7357b3c?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=600&q=80",
        category: "ditich",
        color: "#e74c3c",
        link: "https://www.google.com/maps/place/%C4%90%C3%A8o+H%E1%BA%A3i+V%C3%A2n/@16.1999995,108.1230332,3345m/data=!3m2!1e3!4b1!4m6!3m5!1s0x31422151a4984555:0x9a66217b26b3f759!8m2!3d16.2!4d108.133333!16s%2Fm%2F02rnk9y?hl=vi&entry=ttu&g_ep=EgoyMDI1MTAwOC4wIKXMDSoASAFQAw%3D%3D",
        address: "X√£ Ch√¢n M√¢y LƒÉng C√¥, Th√†nh ph·ªë Hu·∫ø",
        phone: "0234 123 464",
        hours: "M·ªü c·ª≠a c·∫£ ng√†y",
        price: "Mi·ªÖn ph√≠",
        filters: {
          type: "ditich",
          suitability: ["family", "couple", "solo"],
          budget: 0,
          age: ["child", "teen", "adult", "senior"],
          time: 1
        }
      },
      {
        id: 10,
        coords: [16.32695564023601, 107.95730352364052],
        title: "Laguna LƒÉng C√¥",
        description: "Khu ngh·ªâ d∆∞·ª°ng cao c·∫•p v·ªõi ƒë·∫ßy ƒë·ªß ti·ªán nghi, n·∫±m b√™n b·ªù bi·ªÉn LƒÉng C√¥ th∆° m·ªông, l√Ω t∆∞·ªüng cho k·ª≥ ngh·ªâ sang tr·ªçng.",
        image: "https://ygt-res.cloudinary.com/image/upload/c_fit,h_1280,q_80,w_1920/v1614090904/Venues/Laguna%20Lang%20Co%20Golf%20Club/laguna-lang-co-golf-club-1.jpg",
        category: "nghiduong",
        color: "#f39c12",
        link: "https://example.com/laguna-lang-co",
        address: "X√£ Ch√¢n M√¢y LƒÉng C√¥, Th√†nh ph·ªë Hu·∫ø",
        phone: "02343695800",
        hours: "M·ªü c·ª≠a c·∫£ ng√†y",
        price: "T·ª´ 2.500.000 VNƒê/ƒë√™m",
        filters: {
          type: "nghiduong",
          suitability: ["family", "couple"],
          budget: 4,
          age: ["adult"],
          time: 4
        }
      },
      {
        id: 11,
        coords: [16.216834383654582, 108.02855192753158],
        title: "Su·ªëi M∆°",
        description: "D√≤ng su·ªëi th∆° m·ªông v·ªõi c·∫£nh quan thi√™n nhi√™n t∆∞∆°i ƒë·∫πp, l√† ƒëi·ªÉm ƒë·∫øn l√Ω t∆∞·ªüng cho nh·ªØng ai y√™u th√≠ch s·ª± y√™n b√¨nh.",
        image:"https://upload.wikimedia.org/wikipedia/commons/b/b6/Suoi_Mo-Dream_Creek.jpg",
        category: "suoi",
        color: "#27ae60",
        link: "https://example.com/suoi-mo",
        address: "X√£ Ch√¢n M√¢y LƒÉng C√¥, Th√†nh ph·ªë Hu·∫ø",
        phone: "0934194621",
        hours: "M·ªü c·ª≠a c·∫£ ng√†y",
        price: "Mi·ªÖn ph√≠",
        filters: {
          type: "giaitri",
          suitability: ["family", "couple", "solo"],
          budget: 0,
          age: ["child", "teen", "adult", "senior"],
          time: 2
        }
      },
      {
        id: 12,
        coords: [16.275, 108.085],
        title: "Nh√† h√†ng H·∫£i S·∫£n LƒÉng C√¥",
        description: "Nh√† h√†ng chuy√™n ph·ª•c v·ª• h·∫£i s·∫£n t∆∞∆°i s·ªëng v·ªõi view bi·ªÉn tuy·ªát ƒë·∫πp.",
        image: "https://images.unsplash.com/photo-1414235077428-338989a2e8c0?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=600&q=80",
        category: "nhahang",
        color: "#9b59b6",
        link: "https://example.com/nha-hang-hai-san",
        address: "X√£ Ch√¢n M√¢y LƒÉng C√¥, Th√†nh ph·ªë Hu·∫ø",
        phone: "0234 123 465",
        hours: "10:00 - 22:00",
        price: "150.000 - 500.000 VNƒê",
        filters: {
          type: "nhahang",
          suitability: ["family", "couple"],
          budget: 2,
          age: ["teen", "adult", "senior"],
          time: 1
        }
      },
      {
        id: 13,
        coords: [16.285, 108.095],
        title: "Ch·ª£ ƒê√™m LƒÉng C√¥",
        description: "Khu ch·ª£ ƒë√™m s·∫ßm u·∫•t v·ªõi nhi·ªÅu m·∫∑t h√†ng ƒë·∫∑c s·∫£n v√† qu√† l∆∞u ni·ªám.",
        image: "https://images.unsplash.com/photo-1556909114-f6e7ad7d3136?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=600&q=80",
        category: "muasam",
        color: "#e67e22",
        link: "https://example.com/cho-dem",
        address: "X√£ Ch√¢n M√¢y LƒÉng C√¥, Th√†nh ph·ªë Hu·∫ø",
        phone: "",
        hours: "17:00 - 23:00",
        price: "Mi·ªÖn ph√≠ v√†o c·ª≠a",
        filters: {
          type: "muasam",
          suitability: ["family", "couple", "solo"],
          budget: 1,
          age: ["child", "teen", "adult", "senior"],
          time: 1
        }
      }
    ];

    // ========== KH·ªûI T·∫†O ·ª®NG D·ª§NG ==========
    
    // Kh·ªüi t·∫°o b·∫£n ƒë·ªì
    const map = L.map("map").setView(APP_CONFIG.mapCenter, APP_CONFIG.defaultZoom);

    // Th√™m l·ªõp b·∫£n ƒë·ªì
    const osmLayer = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 18,
      attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
    }).addTo(map);

    // Th√™m l·ªõp b·∫£n ƒë·ªì v·ªá tinh
    const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
      maxZoom: 18
    });

    // Bi·∫øn to√†n c·ª•c
    let boundaryLayer;
    let boundaryVisible = true;
    let isSatellite = false;
    let markerObjects = [];
    let currentMarkerIndex = -1;
    
    // Bi·∫øn l∆∞u tr·∫°ng th√°i b·ªô l·ªçc
    let activeFilters = {
      type: null,
      suitability: [],
      budget: 4, // M·∫∑c ƒë·ªãnh: t·∫•t c·∫£ c√°c m·ª©c gi√°
      age: "all", // M·∫∑c ƒë·ªãnh: t·∫•t c·∫£ ƒë·ªô tu·ªïi
      time: 4 // M·∫∑c ƒë·ªãnh: t·∫•t c·∫£ th·ªùi gian
    };

    // ========== H√ÄM TI·ªÜN √çCH ==========
    
    // H√†m t·∫°o icon marker
    function createSimpleIcon(color) {
      return L.divIcon({
        className: 'simple-marker',
        html: `<div style="background-color: ${color}; width: 24px; height: 24px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.5);"></div>`,
        iconSize: [24, 24],
        iconAnchor: [12, 24]
      });
    }

    // H√†m ·∫©n loading indicator
    function hideLoading() {
      const loading = document.getElementById('loading');
      loading.style.display = 'none';
    }

    // H√†m x·ª≠ l√Ω l·ªói
    function handleError(error, context) {
      console.error(`L·ªói trong ${context}:`, error);
    }

    // ========== QU·∫¢N L√ù RANH GI·ªöI ==========
    
    // H√†m t·∫°o ranh gi·ªõi ∆∞·ªõc l∆∞·ª£ng
    function createEstimatedBoundary() {
      const coords = [
        [16.26, 108.00],
        [16.25, 108.10],
        [16.20, 108.12],
        [16.18, 108.06],
        [16.21, 108.00],
      ];
      
      boundaryLayer = L.polygon(coords, {
        color: APP_CONFIG.boundaryColor,
        weight: APP_CONFIG.boundaryWeight,
        fillColor: APP_CONFIG.boundaryColor,
        fillOpacity: APP_CONFIG.boundaryOpacity,
      }).addTo(map);

      boundaryLayer.bindPopup(`
        <div class="popup-title">Ch√¢n M√¢y - LƒÉng C√¥</div>
        <div class="popup-description">V√πng du l·ªãch ven bi·ªÉn</div>
      `);
      
      hideLoading();
    }

    // H√†m t·∫°o ranh gi·ªõi t·ª´ d·ªØ li·ªáu OSM
    function createBoundaryFromOSMData(data) {
      try {
        const relation = data.elements.find((el) => el.type === "relation");
        if (!relation) {
          throw new Error("Kh√¥ng t√¨m th·∫•y relation trong d·ªØ li·ªáu OSM");
        }

        const nodes = new Map();
        data.elements
          .filter((el) => el.type === "node")
          .forEach((node) => nodes.set(node.id, [node.lat, node.lon]));

        const memberWays = relation.members
          .filter((m) => m.type === "way")
          .map((m) =>
            data.elements.find((el) => el.type === "way" && el.id === m.ref)
          )
          .filter(Boolean);

        const wayChains = memberWays.map((way) =>
          way.nodes.map((id) => nodes.get(id)).filter(Boolean)
        );

        const polygons = [];
        while (wayChains.length > 0) {
          let chain = wayChains.shift();
          let extended = true;

          while (extended) {
            extended = false;
            for (let i = 0; i < wayChains.length; i++) {
              const next = wayChains[i];
              const start1 = chain[0], end1 = chain[chain.length - 1];
              const start2 = next[0], end2 = next[next.length - 1];

              const same = (a, b) =>
                Math.abs(a[0] - b[0]) < 0.0001 &&
                Math.abs(a[1] - b[1]) < 0.0001;

              if (same(end1, start2)) {
                chain = [...chain, ...next.slice(1)];
                wayChains.splice(i, 1);
                extended = true;
                break;
              } else if (same(end1, end2)) {
                chain = [...chain, ...next.slice(0, -1).reverse()];
                wayChains.splice(i, 1);
                extended = true;
                break;
              } else if (same(start1, end2)) {
                chain = [...next.slice(0, -1), ...chain];
                wayChains.splice(i, 1);
                extended = true;
                break;
              } else if (same(start1, start2)) {
                chain = [...next.slice(1).reverse(), ...chain];
                wayChains.splice(i, 1);
                extended = true;
                break;
              }
            }
          }

          const first = chain[0];
          const last = chain[chain.length - 1];
          if (
            !(
              Math.abs(first[0] - last[0]) < 0.0001 &&
              Math.abs(first[1] - last[1]) < 0.0001
            )
          ) {
            chain.push(first);
          }

          polygons.push(chain);
        }

        const areas = polygons.map((poly) =>
          turf.area(turf.polygon([poly.map((p) => [p[1], p[0]])]))
        );
        const maxIndex = areas.indexOf(Math.max(...areas));
        const mainPolygon = polygons[maxIndex];

        if (!mainPolygon || mainPolygon.length < 3) {
          throw new Error("Kh√¥ng th·ªÉ t√°i t·∫°o ranh gi·ªõi ch√≠nh x√°c");
        }

        boundaryLayer = L.polygon(mainPolygon, {
          color: APP_CONFIG.boundaryColor,
          weight: APP_CONFIG.boundaryWeight,
          fillColor: APP_CONFIG.boundaryColor,
          fillOpacity: APP_CONFIG.boundaryOpacity,
        }).addTo(map);

        boundaryLayer.bindPopup(`
          <div class="popup-container-custom">
              <div class="popup-header">
                  <button class="close-btn" onclick="this.closest('.leaflet-popup').querySelector('.leaflet-popup-close-btn').click()">√ó</button>
                  <div class="location-title">
                      <span class="icon">üìç</span>
                      <span>X√£ Ch√¢n M√¢y - LƒÉng C√¥</span>
                  </div>
                  <div class="city-badge">üèôÔ∏è TP. Hu·∫ø</div>
              </div>

              <div class="tags-section">
                  <div class="tags-title">
                      <span class="icon">üîÑ</span>
                      <span>S·∫Øp nh·∫≠p t·ª´</span>
                  </div>
                  <div class="tags-container">
                      <span class="tag highlight">Th·ªã tr·∫•n LƒÉng C√¥</span>
                      <span class="tag">X√£ L·ªôc Ti·∫øn</span>
                      <span class="tag">X√£ L·ªôc Vƒ©nh</span>
                      <span class="tag">X√£ L·ªôc Th·ªßy</span>
                  </div>
              </div>

              <div class="info-grid">
                  <div class="info-card green">
                      <div class="info-label">
                          <span class="icon">üìê</span>
                          <span>Di·ªán t√≠ch</span>
                      </div>
                      <div class="info-value">261.38 km¬≤</div>
                  </div>

                  <div class="info-card purple">
                      <div class="info-label">
                          <span class="icon">üìä</span>
                          <span>M·∫≠t ƒë·ªô</span>
                      </div>
                      <div class="info-value">195/km¬≤</div>
                  </div>

                  <div class="info-card pink">
                      <div class="info-label">
                          <span class="icon">üë•</span>
                          <span>D√¢n s·ªë</span>
                      </div>
                      <div class="info-value">50,831</div>
                  </div>

                  <div class="info-card orange">
                      <div class="info-label">
                          <span class="icon">üè∑Ô∏è</span>
                          <span>M√£ x√£</span>
                      </div>
                      <div class="info-value">20137</div>
                  </div>
              </div>

              <div class="admin-section">
                  <div class="admin-title">
                      <span class="icon">üèõÔ∏è</span>
                      <span>Trung t√¢m h√†nh ch√≠nh</span>
                  </div>
                  <div class="admin-value">Th√¥n B√¨nh An, x√£ Ch√¢n M√¢y - LƒÉng C√¥</div>
              </div>

              <div class="footer-section">
                  <div class="footer-location">Ch√¢n M√¢y - LƒÉng C√¥ Commune, Hu·∫ø, Vietnam</div>
                  <div class="osm-id">OSM ID: 19325212</div>
              </div>
          </div>
        `, {
          maxWidth: 380,
          className: 'custom-popup'
        });

        map.fitBounds(boundaryLayer.getBounds());
        hideLoading();
      } catch (error) {
        handleError(error, "createBoundaryFromOSMData");
        createEstimatedBoundary();
      }
    }

    // ========== QU·∫¢N L√ù MARKER V√Ä B·ªò L·ªåC ==========
    
    // H√†m th√™m marker v√†o b·∫£n ƒë·ªì
    function addMarkersToMap() {
      MARKERS_DATA.forEach(function(marker, index) {
        const simpleIcon = createSimpleIcon(marker.color);
        
        const markerObj = L.marker(marker.coords, { icon: simpleIcon })
          .addTo(map)
          .on('click', function() {
            showLocationDetails(index);
            map.setView(marker.coords, 14);
            highlightLocationItem(index);
          });
          
        markerObjects.push(markerObj);
      });
    }

    // H√†m l·ªçc v√† hi·ªÉn th·ªã marker
    function filterAndDisplayMarkers() {
      const filteredMarkers = MARKERS_DATA.filter(marker => {
        // L·ªçc theo lo·∫°i h√¨nh
        if (activeFilters.type && marker.filters.type !== activeFilters.type) {
          return false;
        }
        
        // L·ªçc theo ph√π h·ª£p
        if (activeFilters.suitability.length > 0) {
          const hasMatchingSuitability = activeFilters.suitability.some(suit => 
            marker.filters.suitability.includes(suit)
          );
          if (!hasMatchingSuitability) return false;
        }
        
        // L·ªçc theo ng√¢n s√°ch
        if (marker.filters.budget > activeFilters.budget) {
          return false;
        }
        
        // L·ªçc theo ƒë·ªô tu·ªïi
        if (activeFilters.age !== "all" && !marker.filters.age.includes(activeFilters.age)) {
          return false;
        }
        
        // L·ªçc theo th·ªùi gian
        if (marker.filters.time > activeFilters.time) {
          return false;
        }
        
        return true;
      });
      
      // ·∫®n t·∫•t c·∫£ marker
      markerObjects.forEach(marker => {
        map.removeLayer(marker);
      });
      
      // Hi·ªÉn th·ªã marker ƒë√£ l·ªçc
      filteredMarkers.forEach(markerData => {
        const index = MARKERS_DATA.findIndex(m => m.id === markerData.id);
        if (index !== -1) {
          map.addLayer(markerObjects[index]);
        }
      });
      
      // C·∫≠p nh·∫≠t danh s√°ch ƒë·ªãa ƒëi·ªÉm
      updateLocationList(filteredMarkers);
    }

    // H√†m c·∫≠p nh·∫≠t danh s√°ch ƒë·ªãa ƒëi·ªÉm
    function updateLocationList(filteredMarkers) {
      const locationList = document.getElementById('location-list');
      locationList.innerHTML = '';
      
      filteredMarkers.forEach(function(markerData) {
        const index = MARKERS_DATA.findIndex(m => m.id === markerData.id);
        if (index === -1) return;
        
        const listItem = document.createElement('li');
        listItem.className = 'location-item';
        listItem.setAttribute('data-id', markerData.id);
        
        // T·∫°o tags hi·ªÉn th·ªã
        const tagsHTML = createTagsHTML(markerData.filters);
        
        listItem.innerHTML = `
          <div class="location-icon" style="background-color: ${markerData.color}">
            <i class="fas fa-map-marker-alt"></i>
          </div>
          <div class="location-content">
            <div class="location-title">${markerData.title}</div>
            <div class="location-desc">${markerData.description.substring(0, 80)}...</div>
            <div class="location-tags">
              ${tagsHTML}
            </div>
          </div>
        `;
        
        listItem.addEventListener('click', function() {
          // Di chuy·ªÉn b·∫£n ƒë·ªì ƒë·∫øn v·ªã tr√≠ marker
          map.setView(markerData.coords, 14);
          // Hi·ªÉn th·ªã th√¥ng tin chi ti·∫øt
          showLocationDetails(index);
          // ƒê√°nh d·∫•u item ƒë∆∞·ª£c ch·ªçn
          highlightLocationItem(index);
          
          // T·ª± ƒë·ªông ƒë√≥ng sidebar tr√™n di ƒë·ªông
          if (window.innerWidth <= 768) {
            sidebar.classList.add('collapsed');
            sidebarToggle.innerHTML = '<i class="fas fa-bars"></i>';
          }
        });
        
        locationList.appendChild(listItem);
      });
      
      // Hi·ªÉn th·ªã th√¥ng b√°o n·∫øu kh√¥ng c√≥ k·∫øt qu·∫£
      if (filteredMarkers.length === 0) {
        const noResults = document.createElement('li');
        noResults.innerHTML = `
          <div style="text-align: center; padding: 20px; color: #718096;">
            <i class="fas fa-search" style="font-size: 24px; margin-bottom: 10px;"></i>
            <div>Kh√¥ng t√¨m th·∫•y ƒë·ªãa ƒëi·ªÉm ph√π h·ª£p</div>
          </div>
        `;
        locationList.appendChild(noResults);
      }
    }

    // H√†m t·∫°o HTML cho tags
    function createTagsHTML(filters) {
      let tagsHTML = '';
      
      // Tag lo·∫°i h√¨nh
      const typeLabels = {
        'baibien': 'üèñÔ∏è B√£i bi·ªÉn',
        'nghiduong': 'üè® Resort',
        'nhahang': 'üçΩÔ∏è ·∫®m th·ª±c',
        'ditich': 'üèõÔ∏è Di t√≠ch',
        'giaitri': 'üéØ Gi·∫£i tr√≠',
        'muasam': 'üõçÔ∏è Mua s·∫Øm'
      };
      
      if (typeLabels[filters.type]) {
        tagsHTML += `<div class="location-tag">${typeLabels[filters.type]}</div>`;
      }
      
      // Tag ng√¢n s√°ch
      const budgetLabels = ['üí∞ Mi·ªÖn ph√≠', 'üí∞ Ti·∫øt ki·ªám', 'üí∞ Trung b√¨nh', 'üí∞ Cao c·∫•p', 'üí∞ Luxury'];
      tagsHTML += `<div class="location-tag">${budgetLabels[filters.budget]}</div>`;
      
      // Tag th·ªùi gian
      const timeLabels = ['‚è±Ô∏è D∆∞·ªõi 1h', '‚è±Ô∏è 1-2h', '‚è±Ô∏è 2-4h', '‚è±Ô∏è N·ª≠a ng√†y', '‚è±Ô∏è C·∫£ ng√†y'];
      tagsHTML += `<div class="location-tag">${timeLabels[filters.time]}</div>`;
      
      return tagsHTML;
    }

    // H√†m t·∫°o danh s√°ch ƒë·ªãa ƒëi·ªÉm trong sidebar
    function createLocationList() {
      updateLocationList(MARKERS_DATA);
    }

    // H√†m ƒë√°nh d·∫•u item trong danh s√°ch
    function highlightLocationItem(index) {
      const items = document.querySelectorAll('.location-item');
      items.forEach(function(item, i) {
        if (i === index) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });
      currentMarkerIndex = index;
    }

    // H√†m hi·ªÉn th·ªã chi ti·∫øt ƒë·ªãa ƒëi·ªÉm
    function showLocationDetails(index) {
      const marker = MARKERS_DATA[index];
      const infoPanel = document.getElementById('info-panel');
      
      // C·∫≠p nh·∫≠t th√¥ng tin
      document.getElementById('info-image').src = marker.image;
      document.getElementById('info-title').textContent = marker.title;
      document.getElementById('info-description').textContent = marker.description;
      document.getElementById('info-address').textContent = marker.address;
      document.getElementById('info-phone').textContent = marker.phone || "Kh√¥ng c√≥ th√¥ng tin";
      document.getElementById('info-hours').textContent = marker.hours;
      document.getElementById('info-price').textContent = marker.price;
      
      // C·∫≠p nh·∫≠t tags trong info panel
      const infoTags = document.getElementById('info-tags');
      infoTags.innerHTML = createTagsHTML(marker.filters);
      
      // C·∫≠p nh·∫≠t s·ª± ki·ªán cho c√°c n√∫t
      document.getElementById('info-website').onclick = function() {
        if (marker.link && marker.link !== "https://example.com") {
          window.open(marker.link, '_blank');
        } else {
          alert("Kh√¥ng c√≥ th√¥ng tin website cho ƒë·ªãa ƒëi·ªÉm n√†y");
        }
      };
      
      document.getElementById('info-direction').onclick = function() {
        const url = `https://www.google.com/maps/dir/?api=1&destination=${marker.coords[0]},${marker.coords[1]}`;
        window.open(url, '_blank');
      };
      
      // Hi·ªÉn th·ªã panel
      infoPanel.classList.add('active');
    }

    // ========== X·ª¨ L√ù S·ª∞ KI·ªÜN B·ªò L·ªåC ==========
    
    // H√†m thi·∫øt l·∫≠p b·ªô l·ªçc
    function setupFilters() {
      // B·ªô l·ªçc lo·∫°i h√¨nh
      const typeFilterTags = document.querySelectorAll('.filter-tag[data-type]');
      typeFilterTags.forEach(tag => {
        tag.addEventListener('click', function() {
          const type = this.getAttribute('data-type');
          
          // Toggle active state
          if (this.classList.contains('active')) {
            this.classList.remove('active');
            activeFilters.type = null;
          } else {
            // Remove active from all type filters
            typeFilterTags.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            activeFilters.type = type;
          }
          
          filterAndDisplayMarkers();
        });
      });
      
      // B·ªô l·ªçc ph√π h·ª£p
      const suitabilityTags = document.querySelectorAll('.filter-tag[data-criteria]');
      suitabilityTags.forEach(tag => {
        tag.addEventListener('click', function() {
          const criteria = this.getAttribute('data-criteria');
          
          // Toggle active state
          if (this.classList.contains('active')) {
            this.classList.remove('active');
            activeFilters.suitability = activeFilters.suitability.filter(c => c !== criteria);
          } else {
            this.classList.add('active');
            activeFilters.suitability.push(criteria);
          }
          
          filterAndDisplayMarkers();
        });
      });
      
      // B·ªô l·ªçc ng√¢n s√°ch
      const budgetSlider = document.getElementById('budget-slider');
      budgetSlider.addEventListener('input', function() {
        activeFilters.budget = parseInt(this.value);
        filterAndDisplayMarkers();
      });
      
      // B·ªô l·ªçc ƒë·ªô tu·ªïi
      const ageButtons = document.querySelectorAll('.age-btn');
      ageButtons.forEach(button => {
        button.addEventListener('click', function() {
          const age = this.getAttribute('data-age');
          
          // Remove active from all age buttons
          ageButtons.forEach(btn => btn.classList.remove('active'));
          this.classList.add('active');
          
          activeFilters.age = age;
          filterAndDisplayMarkers();
        });
      });
      
      // B·ªô l·ªçc th·ªùi gian
      const timeSlider = document.getElementById('time-slider');
      timeSlider.addEventListener('input', function() {
        activeFilters.time = parseInt(this.value);
        filterAndDisplayMarkers();
      });
      
      // N√∫t x√≥a t·∫•t c·∫£ b·ªô l·ªçc
      document.getElementById('clear-filters').addEventListener('click', function() {
        // Reset all filters
        activeFilters = {
          type: null,
          suitability: [],
          budget: 4,
          age: "all",
          time: 4
        };
        
        // Reset UI
        typeFilterTags.forEach(tag => tag.classList.remove('active'));
        suitabilityTags.forEach(tag => tag.classList.remove('active'));
        budgetSlider.value = 4;
        timeSlider.value = 4;
        ageButtons.forEach(btn => {
          if (btn.getAttribute('data-age') === 'all') {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });
        
        filterAndDisplayMarkers();
      });
    }

    // H√†m thi·∫øt l·∫≠p toggle cho b·ªô l·ªçc
    function setupFilterToggles() {
      const typeFilterHeader = document.getElementById('type-filter-header');
      const typeFilterContent = document.getElementById('type-filter-content');
      const typeFilterToggle = document.getElementById('type-filter-toggle');
      
      const criteriaFilterHeader = document.getElementById('criteria-filter-header');
      const criteriaFilterContent = document.getElementById('criteria-filter-content');
      const criteriaFilterToggle = document.getElementById('criteria-filter-toggle');
      
      // Toggle b·ªô l·ªçc lo·∫°i h√¨nh
      typeFilterHeader.addEventListener('click', function() {
        typeFilterContent.classList.toggle('collapsed');
        typeFilterToggle.classList.toggle('rotated');
      });
      
      // Toggle b·ªô l·ªçc ti√™u ch√≠
      criteriaFilterHeader.addEventListener('click', function() {
        criteriaFilterContent.classList.toggle('collapsed');
        criteriaFilterToggle.classList.toggle('rotated');
      });
    }

    // ========== X·ª¨ L√ù S·ª∞ KI·ªÜN KH√ÅC ==========
    
    // X·ª≠ l√Ω s·ª± ki·ªán t√¨m ki·∫øm
    function setupSearch() {
      const searchInput = document.getElementById('search-input');
      searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const items = document.querySelectorAll('.location-item');
        
        items.forEach(function(item) {
          const title = item.querySelector('.location-title').textContent.toLowerCase();
          const desc = item.querySelector('.location-desc').textContent.toLowerCase();
          
          if (title.includes(searchTerm) || desc.includes(searchTerm)) {
            item.style.display = 'flex';
          } else {
            item.style.display = 'none';
          }
        });
      });
    }

    // X·ª≠ l√Ω s·ª± ki·ªán sidebar toggle
    function setupSidebar() {
      const sidebar = document.getElementById('sidebar');
      const sidebarToggle = document.getElementById('sidebar-toggle');
      
      sidebarToggle.addEventListener('click', function() {
        sidebar.classList.toggle('collapsed');
        if (sidebar.classList.contains('collapsed')) {
          sidebarToggle.innerHTML = '<i class="fas fa-bars"></i>';
        } else {
          sidebarToggle.innerHTML = '<i class="fas fa-chevron-left"></i>';
        }
      });
    }

    // X·ª≠ l√Ω s·ª± ki·ªán ƒë√≥ng info panel
    function setupInfoPanel() {
      document.getElementById('info-close').addEventListener('click', function() {
        document.getElementById('info-panel').classList.remove('active');
      });
    }

    // X·ª≠ l√Ω s·ª± ki·ªán c√°c n√∫t ƒëi·ªÅu khi·ªÉn b·∫£n ƒë·ªì
    function setupMapControls() {
      // N√∫t locate me
      document.getElementById('locate-me').addEventListener('click', function() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            const latlng = L.latLng(position.coords.latitude, position.coords.longitude);
            map.setView(latlng, 14);
            L.marker(latlng)
              .addTo(map)
              .bindPopup("V·ªã tr√≠ c·ªßa b·∫°n")
              .openPopup();
          }, function(error) {
            alert("Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠ c·ªßa b·∫°n: " + error.message);
          });
        } else {
          alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã");
        }
      });

      // N√∫t toggle boundary
      document.getElementById('toggle-boundary').addEventListener('click', function() {
        if (boundaryLayer) {
          if (boundaryVisible) {
            map.removeLayer(boundaryLayer);
          } else {
            map.addLayer(boundaryLayer);
          }
          boundaryVisible = !boundaryVisible;
        }
      });

      // N√∫t toggle satellite
      document.getElementById('toggle-satellite').addEventListener('click', function() {
        if (isSatellite) {
          map.removeLayer(satelliteLayer);
          map.addLayer(osmLayer);
        } else {
          map.removeLayer(osmLayer);
          map.addLayer(satelliteLayer);
        }
        isSatellite = !isSatellite;
      });

      // N√∫t fullscreen
      document.getElementById('fullscreen').addEventListener('click', function() {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen();
          this.innerHTML = '<i class="fas fa-compress"></i>';
        } else {
          if (document.exitFullscreen) {
            document.exitFullscreen();
            this.innerHTML = '<i class="fas fa-expand"></i>';
          }
        }
      });
    }

    // Thi·∫øt l·∫≠p UX cho thi·∫øt b·ªã di ƒë·ªông
    function setupMobileUX() {
      const isMobile = window.innerWidth <= 768;
      
      if (isMobile) {
        // ƒê√≥ng sidebar khi ch·ªçn ƒë·ªãa ƒëi·ªÉm
        const locationItems = document.querySelectorAll('.location-item');
        locationItems.forEach(item => {
          item.addEventListener('click', () => {
            sidebar.classList.add('collapsed');
            sidebarToggle.innerHTML = '<i class="fas fa-bars"></i>';
          });
        });
        
        // ƒê√≥ng info panel khi nh·∫•n ra ngo√†i (tr√™n di ƒë·ªông)
        document.addEventListener('click', (e) => {
          const infoPanel = document.getElementById('info-panel');
          if (infoPanel.classList.contains('active') && 
              !e.target.closest('.info-panel') && 
              !e.target.closest('.location-item') &&
              !e.target.closest('.simple-marker')) {
            infoPanel.classList.remove('active');
          }
        });
      }
    }

    // ========== KH·ªûI T·∫†O ·ª®NG D·ª§NG ==========
    
    // H√†m kh·ªüi t·∫°o ·ª©ng d·ª•ng
    function initApp() {
      // G·ªçi d·ªØ li·ªáu OSM ƒë·ªÉ t·∫°o ranh gi·ªõi
      fetch(`https://overpass-api.de/api/interpreter?data=[out:json];relation(${APP_CONFIG.osmRelationId});(._;>;);out;`)
        .then((res) => res.json())
        .then(createBoundaryFromOSMData)
        .catch((err) => {
          handleError(err, "fetch OSM data");
          createEstimatedBoundary();
        });

      // Th√™m marker v√†o b·∫£n ƒë·ªì
      addMarkersToMap();
      
      // T·∫°o danh s√°ch ƒë·ªãa ƒëi·ªÉm
      createLocationList();
      
      // Thi·∫øt l·∫≠p c√°c s·ª± ki·ªán
      setupFilters();
      setupFilterToggles();
      setupSearch();
      setupSidebar();
      setupInfoPanel();
      setupMapControls();
      setupMobileUX();
      
      // ·∫®n loading sau khi t·∫£i xong
      setTimeout(hideLoading, 1000);
    }

    // Kh·ªüi ch·∫°y ·ª©ng d·ª•ng khi DOM ƒë√£ s·∫µn s√†ng
    document.addEventListener('DOMContentLoaded', initApp);
    
    // Thi·∫øt l·∫≠p l·∫°i UX khi thay ƒë·ªïi k√≠ch th∆∞·ªõc c·ª≠a s·ªï
    window.addEventListener('resize', setupMobileUX);
  </script>
</body>
</html>